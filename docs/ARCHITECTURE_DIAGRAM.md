# 🏗️ Диаграмма архитектуры

## Общая структура

```
┌─────────────────────────────────────────────────────────────┐
│                         Browser                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    React App                          │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │              UI Components                      │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │  │
│  │  │  │MainMenu  │ │GameSetup │ │GameOver  │       │  │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘       │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │  │
│  │  │  │PauseMenu │ │ScoreBoard│ │GameCanvas│       │  │  │
│  │  │  └──────────┘ └──────────┘ └────┬─────┘       │  │  │
│  │  └────────────────────────────────┼──────────────┘  │  │
│  │                                    │                  │  │
│  │  ┌─────────────────────────────────▼──────────────┐  │  │
│  │  │              Game Core                         │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐           │  │  │
│  │  │  │ GameEngine   │  │  Renderer    │           │  │  │
│  │  │  │              │  │              │           │  │  │
│  │  │  │ - Logic      │  │ - Canvas     │           │  │  │
│  │  │  │ - Physics    │  │ - Drawing    │           │  │  │
│  │  │  │ - Bots       │  │ - Effects    │           │  │  │
│  │  │  └──────┬───────┘  └──────▲───────┘           │  │  │
│  │  │         │                  │                   │  │  │
│  │  │         └──────GameState───┘                   │  │  │
│  │  │                                                │  │  │
│  │  │  ┌──────────────┐                             │  │  │
│  │  │  │InputHandler  │                             │  │  │
│  │  │  │              │                             │  │  │
│  │  │  │ - Keyboard   │                             │  │  │
│  │  │  │ - Touch      │                             │  │  │
│  │  │  └──────────────┘                             │  │  │
│  │  └────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Поток данных

```
User Input (Keyboard/Touch)
         │
         ▼
   InputHandler
         │
         ▼
   GameEngine.changeDirection()
         │
         ▼
   GameEngine.update()
    ┌────┴────┐
    │         │
    ▼         ▼
  Bots     Physics
    │         │
    └────┬────┘
         │
         ▼
    GameState
         │
    ┌────┴────┐
    │         │
    ▼         ▼
Renderer   ScoreBoard
    │
    ▼
  Canvas
```

## Модули и их связи

```
┌─────────────────────────────────────────────────────────┐
│                      App.tsx                            │
│  - Управление экранами                                  │
│  - Создание GameEngine                                  │
│  - Обработка событий                                    │
└────┬────────────────────────────────────────────────────┘
     │
     ├─────────────────────────────────────────────────────┐
     │                                                      │
     ▼                                                      ▼
┌─────────────────┐                            ┌──────────────────┐
│  UI Components  │                            │   Game Core      │
├─────────────────┤                            ├──────────────────┤
│ MainMenu        │                            │ GameEngine       │
│ GameSetup       │                            │ - initGame()     │
│ GameCanvas      │◄───────render()────────────│ - update()       │
│ ScoreBoard      │◄───────state───────────────│ - getState()     │
│ PauseMenu       │                            │                  │
│ GameOver        │                            │ Renderer         │
└─────────────────┘                            │ - render()       │
                                               │                  │
                                               │ InputHandler     │
                                               │ - keyboard       │
                                               │ - touch          │
                                               └──────────────────┘
```

## Игровой цикл

```
┌─────────────────────────────────────────────────────────┐
│                   Game Loop                             │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  requestAnimationFrame(gameLoop)                 │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  if (timestamp - lastUpdate >= GAME_SPEED)       │  │
│  │  {                                                │  │
│  │    ┌──────────────────────────────────────────┐  │  │
│  │    │  GameEngine.update()                     │  │  │
│  │    │  ┌────────────────────────────────────┐  │  │  │
│  │    │  │ 1. Боты думают                     │  │  │  │
│  │    │  │ 2. Змейки двигаются                │  │  │  │
│  │    │  │ 3. Проверка столкновений           │  │  │  │
│  │    │  │ 4. Обновление эффектов             │  │  │  │
│  │    │  │ 5. Обновление частиц               │  │  │  │
│  │    │  │ 6. Обновление пуль                 │  │  │  │
│  │    │  │ 7. Проверка окончания игры         │  │  │  │
│  │    │  └────────────────────────────────────┘  │  │  │
│  │    └──────────────────────────────────────────┘  │  │
│  │    lastUpdate = timestamp                        │  │
│  │  }                                                │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Renderer.render(gameState)                      │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ 1. Очистка canvas                          │  │  │
│  │  │ 2. Рисование сетки                         │  │  │
│  │  │ 3. Рисование частиц                        │  │  │
│  │  │ 4. Рисование еды                           │  │  │
│  │  │ 5. Рисование змеек                         │  │  │
│  │  │ 6. Рисование пуль                          │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Структура GameState

```
GameState
├── players: Player[]
│   ├── snake: Snake
│   │   ├── segments: Position[]
│   │   ├── direction: Direction
│   │   ├── color: ColorScheme
│   │   └── alive: boolean
│   ├── score: number
│   ├── type: 'human' | 'bot'
│   ├── control?: ControlType
│   ├── botStrategy?: BotStrategy
│   ├── isGhost?: boolean
│   ├── ghostTimer?: number
│   ├── specialEffect?: SpecialEffect
│   └── specialEffectTimer?: number
├── foods: Food[]
│   ├── x: number
│   ├── y: number
│   └── isSpecial?: boolean
├── particles: Particle[]
│   ├── x, y: number
│   ├── vx, vy: number
│   ├── life: number
│   ├── maxLife: number
│   └── color: string
├── bullets: Bullet[]
│   ├── x, y: number
│   ├── vx, vy: number
│   ├── owner: number
│   ├── life: number
│   └── framesAlive: number
├── gameMode: GameMode
├── running: boolean
└── paused: boolean
```

## Логика ботов

```
┌─────────────────────────────────────────────────────────┐
│                   Bot AI                                │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  botThink(playerIndex)                           │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Определить стратегию                            │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ AGGRESSIVE  - агрессивно к еде             │  │  │
│  │  │ CAUTIOUS    - осторожно избегает           │  │  │
│  │  │ RANDOM      - случайные движения           │  │  │
│  │  │ TERRITORIAL - защита территории            │  │  │
│  │  │ HUNTER      - охота на игроков (len>=80)   │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Найти цель                                      │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ - Ближайшая еда                            │  │  │
│  │  │ - Ближайший игрок (для HUNTER)             │  │  │
│  │  │ - Свободное пространство                   │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Получить безопасные направления                │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ - Исключить обратное направление           │  │  │
│  │  │ - Проверить столкновения                   │  │  │
│  │  │ - Оценить свободное пространство           │  │  │
│  │  │ - Оценить возможность поворотов            │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Оценить каждое направление                      │  │
│  │  ┌────────────────────────────────────────────┐  │  │
│  │  │ score = distanceScore                      │  │  │
│  │  │       + spaceScore                         │  │  │
│  │  │       + turnsScore                         │  │  │
│  │  │       + diversityScore                     │  │  │
│  │  └────────────────────────────────────────────┘  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Выбрать лучшее направление                      │  │
│  │  direction = max(score)                          │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Обработка ввода

```
┌─────────────────────────────────────────────────────────┐
│                  Input Flow                             │
│                                                         │
│  Keyboard Event                Touch Event              │
│       │                             │                   │
│       ▼                             ▼                   │
│  ┌─────────────┐              ┌─────────────┐          │
│  │ keydown     │              │ touchstart  │          │
│  │ - W/Ц       │              │ - save pos  │          │
│  │ - A/Ф       │              │             │          │
│  │ - S/Ы       │              │ touchend    │          │
│  │ - D/В       │              │ - calc dir  │          │
│  └──────┬──────┘              └──────┬──────┘          │
│         │                            │                  │
│         └────────────┬───────────────┘                  │
│                      │                                  │
│                      ▼                                  │
│         ┌────────────────────────┐                      │
│         │  InputHandler          │                      │
│         │  - Validate direction  │                      │
│         │  - Check reverse       │                      │
│         └────────────┬───────────┘                      │
│                      │                                  │
│                      ▼                                  │
│         ┌────────────────────────┐                      │
│         │  onDirectionChange()   │                      │
│         │  (callback)            │                      │
│         └────────────┬───────────┘                      │
│                      │                                  │
│                      ▼                                  │
│         ┌────────────────────────┐                      │
│         │  GameEngine            │                      │
│         │  .changeDirection()    │                      │
│         └────────────────────────┘                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Рендеринг

```
┌─────────────────────────────────────────────────────────┐
│                  Rendering Pipeline                     │
│                                                         │
│  GameState                                              │
│       │                                                 │
│       ▼                                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Renderer.render(state)                         │   │
│  └────────────────┬────────────────────────────────┘   │
│                   │                                     │
│       ┌───────────┼───────────┐                         │
│       │           │           │                         │
│       ▼           ▼           ▼                         │
│  ┌────────┐ ┌────────┐ ┌────────┐                      │
│  │ Clear  │ │ Grid   │ │Particles│                     │
│  └────────┘ └────────┘ └────────┘                      │
│       │           │           │                         │
│       └───────────┼───────────┘                         │
│                   │                                     │
│       ┌───────────┼───────────┐                         │
│       │           │           │                         │
│       ▼           ▼           ▼                         │
│  ┌────────┐ ┌────────┐ ┌────────┐                      │
│  │ Food   │ │ Snakes │ │Bullets │                      │
│  └────────┘ └────────┘ └────────┘                      │
│       │           │           │                         │
│       └───────────┼───────────┘                         │
│                   │                                     │
│                   ▼                                     │
│            ┌─────────────┐                              │
│            │   Canvas    │                              │
│            │   Display   │                              │
│            └─────────────┘                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Сравнение архитектур

```
┌─────────────────────────────────────────────────────────┐
│              Старая архитектура                         │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │                index.html                         │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │  HTML + CSS + JavaScript (5100 строк)      │  │  │
│  │  │  - UI                                       │  │  │
│  │  │  - Логика                                   │  │  │
│  │  │  - Рендеринг                                │  │  │
│  │  │  - Боты                                     │  │  │
│  │  │  - Все вместе                               │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘

                         ▼ Миграция ▼

┌─────────────────────────────────────────────────────────┐
│              Новая архитектура                          │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │                  src/                             │  │
│  │  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │ components/ │  │    core/    │               │  │
│  │  │  (React UI) │  │  (Логика)   │               │  │
│  │  └─────────────┘  └─────────────┘               │  │
│  │  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │   types/    │  │ constants/  │               │  │
│  │  │(TypeScript) │  │  (Данные)   │               │  │
│  │  └─────────────┘  └─────────────┘               │  │
│  │  ┌─────────────┐                                │  │
│  │  │  styles/    │                                │  │
│  │  │   (CSS)     │                                │  │
│  │  └─────────────┘                                │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```
