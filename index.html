<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ó–º–µ–π–∫–∞ ‚Äî –¥–æ 8 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #7C4DFF;
      --secondary-color: #9C27B0;
      --success-color: #00C853;
      --danger-color: #f72585;
      --warning-color: #ff9e6d;
      --dark-bg: #0d1b2a;
      --light-text: #f8f9fa;
      --card-bg: rgba(30, 20, 50, 0.85);
      --purple-glow: rgba(124, 77, 255, 0.6);
      --green-glow: rgba(0, 200, 83, 0.6);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
    }
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: linear-gradient(135deg, #1a0033, #0d4d2d, #2d1b4e, #004d26);
      background-size: 400% 400%;
      font-family: 'Exo 2', 'Segoe UI', sans-serif;
      color: var(--light-text);
      padding: 8px;
      min-height: 100vh;
      animation: gradientBG 15s ease infinite;
      overflow-y: auto;
      overflow-x: hidden;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    h1 {
      margin: 5px 0 10px;
      text-shadow: 0 4px 15px rgba(124, 77, 255, 0.8), 0 0 30px rgba(0, 200, 83, 0.5);
      font-size: clamp(1.4em, 4vw, 2.4em);
      text-align: center;
      background: linear-gradient(to right, #00FF7F, #7C4DFF, #00C853, #9C27B0);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      letter-spacing: -0.5px;
      position: relative;
      animation: titleGlow 3s ease-in-out infinite;
    }
    @keyframes titleGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    h1::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, #00C853, #7C4DFF);
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(0, 200, 83, 0.8);
    }
    h2 {
      margin-bottom: 10px;
      font-size: clamp(1.3em, 3.5vw, 1.6em);
      color: #f8f9fa;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      font-weight: 600;
    }
    #setup-screen, #controls-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(12px, 2vh, 20px);
      text-align: center;
      background: var(--card-bg);
      padding: clamp(16px, 3vw, 24px);
      border-radius: 20px;
      width: calc(100% - 24px);
      max-width: 720px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35), 0 0 20px var(--purple-glow), 0 0 40px var(--green-glow);
      backdrop-filter: blur(10px);
      border: 2px solid transparent;
      background-image: linear-gradient(var(--card-bg), var(--card-bg)), 
                        linear-gradient(135deg, #7C4DFF, #00C853, #9C27B0);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      animation: fadeInUp 0.6s ease-out forwards, borderGlow 3s ease-in-out infinite;
      opacity: 0;
      transform: translateY(20px);
    }
    @keyframes borderGlow {
      0%, 100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35), 0 0 20px var(--purple-glow); }
      50% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35), 0 0 40px var(--green-glow); }
    }
    #setup-screen.active, #controls-screen.active {
      opacity: 1;
      transform: translateY(0);
    }
    #controls-screen {
      display: none;
    }
    .selection-row {
      display: flex;
      gap: clamp(8px, 2vw, 12px);
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      background: rgba(0, 0, 0, 0.2);
      padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 16px);
      border-radius: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã */
    .game-mode-selection {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
    }
    .mode-selector {
      display: flex;
      gap: clamp(8px, 2vw, 10px);
      position: relative;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
    .mode-btn {
      padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2.5vw, 14px);
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.6), rgba(156, 39, 176, 0.6));
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      position: relative;
      min-width: clamp(80px, 18vw, 100px);
      text-align: center;
      font-size: clamp(13px, 2.5vw, 15px);
      font-family: 'Exo 2', sans-serif;
      border: 1px solid rgba(124, 77, 255, 0.3);
      font-size: clamp(12px, 2.5vw, 14px);
    }
    .mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--purple-glow), 0 0 20px var(--green-glow);
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.8), rgba(0, 200, 83, 0.6));
    }
    .mode-btn.active {
      background: linear-gradient(45deg, var(--primary-color), var(--success-color));
      box-shadow: 0 0 0 2px #00C853, 0 0 15px var(--purple-glow), 0 0 25px var(--green-glow);
      border-color: #00C853;
    }
    .mode-btn:focus, .mode-btn:focus-visible {
      outline: 3px solid #00FF7F;
      outline-offset: 2px;
    }
    .ghost-container {
      position: relative;
    }
    .ghost-submodes {
      position: absolute;
      top: 100%;
      left: 0;
      display: none;
      flex-direction: column;
      gap: 8px;
      background: rgba(30, 41, 59, 0.95);
      padding: 12px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      z-index: 10;
      border: 1px solid rgba(121, 82, 179, 0.5);
      animation: fadeInUp 0.3s ease;
      backdrop-filter: blur(8px);
      min-width: 180px;
    }
    .ghost-container:hover .ghost-submodes {
      display: flex;
    }
    .submode-btn {
      padding: 6px 12px;
      background: rgba(121, 82, 179, 0.6);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: clamp(12px, 2.5vw, 14px);
      text-align: left;
      font-family: 'Exo 2', sans-serif;
    }
    .submode-btn:hover {
      background: rgba(121, 82, 179, 0.9);
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .mode-description {
      position: fixed;
      left: auto;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: clamp(280px, 30vw, 320px);
      max-width: calc(100vw - 40px);
      background: rgba(13, 27, 42, 0.95);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      border: 1px solid rgba(121, 82, 179, 0.4);
      font-size: 14px;
      animation: fadeIn 0.2s ease;
      backdrop-filter: blur(10px);
      color: #e9ecef;
      pointer-events: none;
    }
    .description-content {
      display: none;
    }
    .description-content.active {
      display: block;
    }
    .mode-description::before {
      content: '';
      position: absolute;
      left: 50%;
      top: -8px;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid rgba(13, 27, 42, 0.95);
    }
    .description-content h3 {
      color: #00FF7F;
      margin-bottom: 8px;
      font-size: 18px;
      text-shadow: 0 0 10px var(--green-glow);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (–≤—Å–µ—Ö –∫—Ä–æ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è) */
    .custom-select-container {
      position: relative;
      display: inline-block;
      margin: 0;
      padding: 0;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
    .custom-select-button {
      padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2.5vw, 14px);
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.6), rgba(156, 39, 176, 0.6));
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-family: 'Exo 2', sans-serif;
      text-align: center;
      width: 100%;
      max-width: clamp(140px, 35vw, 180px);
      border: 1px solid rgba(124, 77, 255, 0.3);
      box-shadow: 0 4px 12px var(--purple-glow), 0 0 20px var(--green-glow);
      position: relative;
      z-index: 2;
      margin: 0;
      font-size: clamp(12px, 2.5vw, 14px);
    }
    .custom-select-button:hover {
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.8), rgba(0, 200, 83, 0.6));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--purple-glow), 0 0 35px var(--green-glow);
    }
    .custom-select-button:focus, .custom-select-button:focus-visible {
      outline: 3px solid #00FF7F;
      outline-offset: 2px;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–ø—Ü–∏–π */
    .custom-select-options {
      position: absolute;
      top: 100%; /* –ü—Ä—è–º–æ–µ –ø—Ä–∏–ª–µ–≥–∞–Ω–∏–µ –∫ –∫–Ω–æ–ø–∫–µ */
      left: 0;
      display: none;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(13, 27, 42, 0.95));
      padding: 12px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 15px var(--purple-glow), 0 0 25px var(--green-glow);
      z-index: 100;
      border: 1px solid rgba(121, 82, 179, 0.5);
      animation: borderGlowCustom 3s ease-in-out infinite;
      backdrop-filter: blur(8px);
      min-width: 180px;
      width: 100%;
      margin: 0;
      padding: 12px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
    .custom-select-container:hover .custom-select-options {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    .custom-select-option {
      padding: 6px 10px;
      background: linear-gradient(135deg, rgba(67, 97, 238, 0.7), rgba(121, 82, 179, 0.7));
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: clamp(12px, 2.5vw, 14px);
      font-family: 'Exo 2', sans-serif;
      text-align: center;
      border: 1px solid transparent;
    }
    .custom-select-option:hover {
      background: linear-gradient(135deg, rgba(67, 97, 238, 0.9), rgba(0, 200, 83, 0.6));
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .custom-select-option:focus, .custom-select-option:focus-visible {
      outline: 2px solid #00FF7F;
      outline-offset: 1px;
      border-color: #00FF7F;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–π –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ */
    @keyframes borderGlowCustom {
      0%, 100% {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 10px var(--purple-glow), 0 0 20px var(--green-glow);
      }
      50% {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 20px var(--green-glow), 0 0 30px var(--purple-glow);
      }
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–Ω–æ–ø–æ–∫) */
    .control-settings .custom-select-container {
      position: relative;
      width: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      padding: 0;
    }
    .control-settings .custom-select-button {
      max-width: none;
      width: auto;
      min-width: clamp(130px, 30vw, 150px);
      justify-content: flex-start;
      padding: 8px 12px;
      font-size: clamp(12px, 2.5vw, 14px);
      margin: 0;
    }
    .control-settings .custom-select-options {
      top: 0;
      left: calc(100% + 1px);
      right: auto;
      min-width: 180px;
      width: 180px;
      border-radius: 16px !important;
      border-top-left-radius: 16px !important;
      border-top-right-radius: 16px !important;
    }
    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 380px;
      margin: 6px 0;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .control-row:hover {
      background: rgba(0, 0, 0, 0.25);
      transform: translateX(5px);
    }
    label {
      font-size: clamp(13px, 2.5vw, 16px);
      font-weight: 600;
      color: #e9ecef;
    }
    #error-message {
      color: var(--danger-color);
      font-size: 14px;
      min-height: 22px;
      font-weight: 600;
      font-family: 'Exo 2', sans-serif;
      padding: 5px 10px;
      border-radius: 8px;
      background: rgba(247, 37, 133, 0.1);
      margin: 5px 0;
      animation: pulseError 0.5s;
    }
    @keyframes pulseError {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    button {
      margin-top: clamp(8px, 1.5vh, 10px);
      padding: clamp(10px, 2vw, 14px) clamp(24px, 5vw, 32px);
      font-size: clamp(14px, 3vw, 18px);
      background: linear-gradient(135deg, var(--primary-color), var(--success-color), var(--secondary-color));
      color: white;
      border: 2px solid rgba(0, 200, 83, 0.5);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 15px var(--purple-glow), 0 0 20px var(--green-glow);
      position: relative;
      overflow: hidden;
      font-family: 'Exo 2', sans-serif;
    }
    button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: rotate(30deg);
      transition: all 0.6s;
      z-index: 0;
    }
    button span {
      position: relative;
      z-index: 1;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--purple-glow), 0 0 35px var(--green-glow);
      border-color: #00FF7F;
    }
    button:hover::after {
      animation: shine 1.5s infinite;
    }
    @keyframes shine {
      0% { left: -50%; }
      100% { left: 150%; }
    }
    button:active {
      transform: translateY(1px);
    }
    button:disabled {
      background: linear-gradient(45deg, #6c757d, #495057);
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    button.secondary {
      background: linear-gradient(45deg, #495057, #343a40);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }
    button.secondary:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }
    button:focus, button:focus-visible {
      outline: 3px solid #00FF7F;
      outline-offset: 3px;
    }
    #game-container {
      position: relative;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), 0 0 30px var(--purple-glow), 0 0 50px var(--green-glow);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      width: 100%;
      max-width: min(95vw, 1200px);
      max-height: calc(100vh - 120px);
      margin: 8px 0;
      border: 3px solid transparent;
      background: rgba(13, 27, 42, 0.7);
      background-image: linear-gradient(rgba(13, 27, 42, 0.7), rgba(13, 27, 42, 0.7)),
                        linear-gradient(135deg, #7C4DFF, #00C853, #9C27B0);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      animation: containerGlow 3s infinite alternate;
    }
    @keyframes containerGlow {
      0% { box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), 0 0 20px var(--purple-glow), 0 0 30px var(--green-glow); }
      100% { box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), 0 0 40px var(--green-glow), 0 0 60px var(--purple-glow); }
    }
    #game-board {
      background: var(--dark-bg);
      display: block;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    #scores, #legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
      max-width: 95vw;
      margin: 6px 0;
      font-size: clamp(11px, 2vw, 15px);
      font-weight: 700;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
      font-family: 'Exo 2', sans-serif;
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(30, 41, 59, 0.6);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: clamp(11px, 2vw, 14px);
    }
    .legend-color {
      width: clamp(10px, 2vw, 14px);
      height: clamp(10px, 2vw, 14px);
      border-radius: 3px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
    }
    #game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      z-index: 10;
      backdrop-filter: blur(5px);
    }
    #game-over.active {
      opacity: 1;
      pointer-events: all;
      animation: modalPop 0.6s ease-out;
    }
    @keyframes modalPop {
      0% { transform: scale(0.8); opacity: 0; }
      80% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .game-over-content {
      text-align: center;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: fadeIn 0.8s ease-out;
      padding: 10px;
    }
    .game-over-content h2 {
      font-size: clamp(1.6em, 4vw, 2.2em);
      margin-bottom: 16px;
      color: #fff;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
      background: linear-gradient(to right, #ff9e6d, #f72585);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    #final-scores {
      margin: 15px 0;
      max-height: clamp(120px, 30vh, 180px);
      overflow-y: auto;
      padding: 15px;
      background: rgba(13, 27, 42, 0.7);
      border-radius: 16px;
      width: 100%;
      max-width: 450px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    #final-scores div {
      padding: 6px 0;
      font-size: clamp(13px, 2.5vw, 16px);
      font-weight: 600;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.15);
    }
    #final-scores div:last-child {
      border-bottom: none;
    }
    #winner {
      font-size: clamp(1.1em, 3vw, 1.4em);
      font-weight: 700;
      color: #4cc9f0;
      text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
      margin: 8px 0;
    }
    .instructions {
      margin-top: clamp(10px, 2vh, 15px);
      padding: clamp(10px, 2vw, 12px);
      background: rgba(30, 41, 59, 0.7);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      font-size: clamp(12px, 2.5vw, 14px);
      text-align: center;
      border: 1px solid rgba(76, 175, 80, 0.3);
      box-sizing: border-box;
    }
    .instructions p {
      margin: 6px 0;
      line-height: 1.4;
    }
    kbd {
      background: rgba(0, 0, 0, 0.4);
      padding: 2px 6px;
      border-radius: 6px;
      font-family: 'Exo 2', monospace;
      font-size: clamp(11px, 2vw, 14px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      display: inline-block;
      min-width: clamp(22px, 4vw, 28px);
      text-align: center;
    }
    .control-preview {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
      font-size: clamp(11px, 2vw, 14px);
    }
    .player-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      display: inline-block;
    }
    .ghost-indicator {
      position: relative;
      display: inline-block;
      margin-left: 5px;
    }
    .ghost-indicator::after {
      content: 'üëª';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 12px;
      opacity: 0.8;
    }
    .selected-mode-display {
      display: flex;
      gap: clamp(8px, 2vw, 10px);
      align-items: center;
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.15), rgba(0, 200, 83, 0.15));
      padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 20px);
      border-radius: 12px;
      width: 100%;
      font-weight: 600;
      font-size: clamp(13px, 2.5vw, 15px);
      border: 2px solid transparent;
      background-image: linear-gradient(135deg, rgba(124, 77, 255, 0.15), rgba(0, 200, 83, 0.15)),
                        linear-gradient(135deg, #7C4DFF, #00C853);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      box-sizing: border-box;
    }
    .selected-mode-display span.mode-name {
      color: #00FF7F;
      font-weight: 700;
      text-shadow: 0 0 10px var(--green-glow);
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-height: 500px) and (orientation: landscape) {
      body {
        padding: 2px;
        overflow-y: auto;
      }
      h1 {
        font-size: clamp(1em, 3vh, 1.5em);
        margin: 2px 0 3px;
      }
      h1::after {
        display: none;
      }
      #setup-screen, #controls-screen {
        padding: 8px;
        gap: 6px;
        max-height: calc(100vh - 30px);
        border-radius: 12px;
      }
      h2 {
        font-size: clamp(1em, 3vh, 1.3em);
        margin-bottom: 6px;
      }
      .selection-row {
        padding: 6px 10px;
        gap: 8px;
      }
      button {
        padding: 6px 14px;
        font-size: clamp(12px, 2.5vh, 14px);
        margin-top: 3px;
      }
      .instructions {
        padding: 8px;
        font-size: 11px;
        margin-top: 8px;
      }
      .control-row {
        padding: 5px 8px;
        margin: 3px 0;
      }
      #game-container {
        max-height: calc(100vh - 40px);
        margin: 2px 0;
        border-radius: 8px;
      }
      #scores, #legend {
        font-size: clamp(9px, 1.8vh, 12px);
        gap: 4px;
        margin: 2px 0;
      }
      .legend-item {
        padding: 3px 8px;
      }
      .mode-indicator {
        font-size: 10px;
        padding: 2px 6px;
        top: 5px;
        right: 5px;
      }
      .pause-btn {
        padding: 5px 8px;
        font-size: 14px;
        top: 5px;
        right: 5px;
      }
      .fullscreen-btn {
        padding: 5px 8px;
        font-size: 14px;
        top: 5px;
        left: 5px;
      }
      .mode-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 80px;
      }
      .custom-select-button {
        padding: 6px 10px;
        font-size: 12px;
      }
      .custom-select-option {
        padding: 5px 8px;
        font-size: 12px;
      }
      label {
        font-size: 12px;
      }
      .selected-mode-display {
        padding: 6px 10px;
        font-size: 12px;
      }
      .control-preview {
        font-size: 11px;
        gap: 4px;
      }
      kbd {
        padding: 2px 4px;
        font-size: 10px;
        min-width: 18px;
      }
      .pause-menu h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      .pause-menu-btn {
        padding: 8px 24px;
        font-size: 14px;
        min-width: 140px;
      }
      .game-over-content h2 {
        font-size: 1.4em;
      }
      #final-scores {
        max-height: 100px;
        padding: 10px;
      }
      #final-scores div {
        font-size: 12px;
        padding: 4px 0;
      }
    }
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-height: 400px) and (orientation: landscape) {
      h1 {
        font-size: 0.9em;
        margin: 1px 0 2px;
      }
      #setup-screen, #controls-screen {
        padding: 6px;
        gap: 4px;
      }
      h2 {
        font-size: 1em;
        margin-bottom: 4px;
      }
      button {
        padding: 5px 12px;
        font-size: 11px;
      }
      .selection-row {
        padding: 4px 8px;
      }
      .instructions {
        padding: 6px;
        font-size: 10px;
        margin-top: 6px;
      }
    }
    @media (max-width: 768px) {
      h1 { font-size: clamp(1.5em, 4vw, 1.9em); }
      .mode-description {
        width: clamp(260px, 80vw, 300px);
        font-size: 13px;
        right: 10px;
      }
      #setup-screen, #controls-screen { padding: 16px; gap: 12px; }
      button { font-size: clamp(14px, 3vw, 16px); padding: 10px 20px; }
      .selection-row { flex-direction: column; gap: 10px; }
      #scores, #legend { font-size: clamp(12px, 2.5vw, 13px); gap: 6px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: clamp(1.4em, 5vw, 1.7em); }
      h2 { font-size: clamp(1.2em, 4vw, 1.4em); }
      .ghost-container {
        width: 100%;
      }
      .mode-selector {
        flex-direction: column;
        align-items: center;
      }
      button { font-size: clamp(13px, 3.5vw, 15px); padding: 8px 18px; }
      #game-container { margin: 6px 0; }
      .mode-description {
        display: none !important;
      }
      .selected-mode-display {
        padding: 8px 12px;
        font-size: clamp(12px, 3vw, 14px);
      }
      /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
      .custom-select-container {
        width: 100%;
      }
      .custom-select-options {
        width: 100% !important;
        left: 0 !important;
      }
      .control-settings .custom-select-options {
        left: 0 !important;
        top: 100% !important;
        width: 100% !important;
        min-width: 100% !important;
      }
      .instructions {
        font-size: 12px;
        padding: 12px;
      }
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Å—Ç–∏—Ü */
    .particle {
      position: absolute;
      pointer-events: none;
      z-index: 5;
      opacity: 0;
    }
    .floating-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 4s infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç—Ä–µ–ª—å–±—ã */
    .shoot-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      padding: 12px 20px;
      font-size: 16px;
      background: radial-gradient(circle, #FFD700, #FFA500);
      color: #333;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
      display: none;
    }
    .shoot-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 6px rgba(255, 215, 0, 0.8);
    }
    .shoot-btn.show {
      display: block;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }
    .mode-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(30, 41, 59, 0.9);
      padding: 4px 10px;
      border-radius: 16px;
      font-size: clamp(11px, 2vw, 13px);
      z-index: 10;
      border: 1px solid rgba(124, 77, 255, 0.5);
      backdrop-filter: blur(4px);
      display: none;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑—ã */
    .pause-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(30, 41, 59, 0.7);
      border: 2px solid rgba(124, 77, 255, 0.5);
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      z-index: 15;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      display: none;
      font-size: clamp(16px, 3vw, 20px);
      color: white;
      user-select: none;
    }
    .pause-btn:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(124, 77, 255, 0.8);
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(124, 77, 255, 0.6);
    }
    .pause-btn:active {
      transform: scale(0.95);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
    .fullscreen-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(30, 41, 59, 0.7);
      border: 2px solid rgba(124, 77, 255, 0.5);
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      z-index: 100;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      display: block;
      font-size: clamp(16px, 3vw, 20px);
      color: white;
      user-select: none;
    }
    .fullscreen-btn:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(124, 77, 255, 0.8);
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(124, 77, 255, 0.6);
    }
    .fullscreen-btn:active {
      transform: scale(0.95);
    }
    /* –ú–µ–Ω—é –ø–∞—É–∑—ã */
    .pause-menu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease;
    }
    .pause-menu.active {
      display: flex;
    }
    .pause-menu h2 {
      color: #00FF7F;
      margin-bottom: 30px;
      font-size: clamp(1.8em, 5vw, 2.5em);
      text-shadow: 0 0 20px rgba(0, 255, 127, 0.8);
    }
    .pause-menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    .pause-menu-btn {
      padding: 12px 40px;
      font-size: clamp(15px, 3vw, 18px);
      background: linear-gradient(135deg, var(--primary-color), var(--success-color));
      color: white;
      border: 2px solid rgba(0, 200, 83, 0.5);
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-family: 'Exo 2', sans-serif;
      box-shadow: 0 6px 15px var(--purple-glow);
      min-width: clamp(160px, 40vw, 200px);
    }
    .pause-menu-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--purple-glow), 0 0 35px var(--green-glow);
      border-color: #00FF7F;
    }
    .pause-menu-btn:active {
      transform: translateY(1px);
    }
    .pause-menu-btn:focus, .pause-menu-btn:focus-visible {
      outline: 3px solid #00FF7F;
      outline-offset: 3px;
    }
    .pause-menu-btn.secondary {
      background: linear-gradient(45deg, #495057, #343a40);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }
    .pause-menu-btn.secondary:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }
    .effect-indicator {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.9);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: clamp(11px, 2vw, 14px);
      z-index: 5;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: slideUp 0.3s ease-out;
      backdrop-filter: blur(4px);
      display: flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
      max-width: 90%;
    }
    @keyframes slideUp {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="floating-bg" id="floating-bg"></div>
  <h1>–ó–º–µ–π–∫–∞ ‚Äî –¥–æ 8 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
  <div class="mode-indicator" id="mode-indicator"></div>
  <button class="pause-btn" id="pause-btn">‚è∏</button>
  <button class="fullscreen-btn" id="fullscreen-btn">‚õ∂</button>
  <div id="setup-screen">
    <h2>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–≥—Ä—É</h2>
    <div class="selection-row">
      <label for="human-players">–ò–≥—Ä–æ–∫–æ–≤ (1‚Äì4):</label>
      <div class="custom-select-container" id="human-players-container">
        <button class="custom-select-button" data-value="1">1</button>
        <div class="custom-select-options">
          <div class="custom-select-option" data-value="1">1</div>
          <div class="custom-select-option" data-value="2">2</div>
          <div class="custom-select-option" data-value="3">3</div>
          <div class="custom-select-option" data-value="4">4</div>
        </div>
      </div>
    </div>
    <div class="selection-row">
      <label for="bot-count">–ë–æ—Ç–æ–≤ (0‚Äì7):</label>
      <div class="custom-select-container" id="bot-count-container">
        <button class="custom-select-button" data-value="0">0</button>
        <div class="custom-select-options">
          <div class="custom-select-option" data-value="0">0</div>
          <div class="custom-select-option" data-value="1">1</div>
          <div class="custom-select-option" data-value="2">2</div>
          <div class="custom-select-option" data-value="3">3</div>
          <div class="custom-select-option" data-value="4">4</div>
          <div class="custom-select-option" data-value="5">5</div>
          <div class="custom-select-option" data-value="6">6</div>
          <div class="custom-select-option" data-value="7">7</div>
        </div>
      </div>
    </div>
    <div class="selection-row game-mode-selection">
      <label>–†–µ–∂–∏–º –∏–≥—Ä—ã:</label>
      <div class="mode-selector">
        <button class="mode-btn active" data-mode="classic">–ö–ª–∞—Å—Å–∏–∫–∞</button>
        <div class="ghost-container">
          <button class="mode-btn" data-mode="ghost-main">–ü—Ä–∏–∑—Ä–∞–∫</button>
          <div class="ghost-submodes">
            <button class="submode-btn" data-mode="half-ghost">–ü–æ–ª—É–ø—Ä–∏–∑—Ä–∞–∫</button>
            <button class="submode-btn" data-mode="family-ghost">–°–µ–º–µ–π–∫–∞ –Ω–µ–¥–æ–ø—Ä–∏–∑—Ä–∞–∫–æ–≤</button>
            <button class="submode-btn" data-mode="full-ghost">–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫</button>
            <button class="submode-btn" data-mode="all-ghosts">–ö–æ–º–ø–∞—à–∫–∞ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤</button>
          </div>
        </div>
        <button class="mode-btn" data-mode="magic-shooter">–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä</button>
        <div class="mode-description">
          <div class="description-content active" data-mode="classic">
            <h3>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º</h3>
            <p>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∑–º–µ–π–∫–∏. –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Ö–≤–æ—Å—Ç–æ–º –∏–ª–∏ –¥—Ä—É–≥–∏–º–∏ –∑–º–µ–π–∫–∞–º–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø—Ä–æ–∏–≥—Ä—ã—à—É. –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω—ã –Ω–∞ –ø–æ–ª–µ.</p>
          </div>
          <div class="description-content" data-mode="ghost-main">
            <h3>–†–µ–∂–∏–º "–ü—Ä–∏–∑—Ä–∞–∫"</h3>
            <p>–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –∑–º–µ–π–∫–∏ –º–æ–≥—É—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–µ–≤–∏–¥–∏–º—ã–º–∏. –í–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≥–æ–ª–æ–≤—ã —Å –≥–ª–∞–∑–∞–º–∏. –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º.</p>
          </div>
          <div class="description-content" data-mode="half-ghost">
            <h3>–ü–æ–ª—É–ø—Ä–∏–∑—Ä–∞–∫</h3>
            <p>–°–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏–≥—Ä–æ–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–≤–∏–¥–∏–º—ã–º–∏ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥. –•–≤–æ—Å—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–≤–∏–¥–∏–º –∏ –Ω–µ –∏–º–µ–µ—Ç —Ö–∏—Ç–±–æ–∫—Å–∞. –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∏—Å—á–µ–∑–∞–Ω–∏—è–º–∏ –Ω–µ –º–µ–Ω—å—à–µ 5 —Å–µ–∫—É–Ω–¥.</p>
          </div>
          <div class="description-content" data-mode="family-ghost">
            <h3>–°–µ–º–µ–π–∫–∞ –Ω–µ–¥–æ–ø—Ä–∏–∑—Ä–∞–∫–æ–≤</h3>
            <p>–í—Å–µ –∑–º–µ–π–∫–∏ (–∏–≥—Ä–æ–∫–∏ –∏ –±–æ—Ç—ã) –º–æ–≥—É—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏–∑—Ä–∞–∫–∞–º–∏. –•–≤–æ—Å—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞ –Ω–µ–≤–∏–¥–∏–º, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ö–∏—Ç–±–æ–∫—Å, —Ç–æ –µ—Å—Ç—å –æ–± –Ω–µ–≥–æ –º–æ–∂–Ω–æ —É–º–µ—Ä–µ—Ç—å.</p>
          </div>
          <div class="description-content" data-mode="full-ghost">
            <h3>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫</h3>
            <p>–ò–≥—Ä–æ–∫–∏-–ª—é–¥–∏ —è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏–∑—Ä–∞–∫–∞–º–∏ —Å –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã. –•–≤–æ—Å—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞ –Ω–µ–≤–∏–¥–∏–º. –û–± —Ö–≤–æ—Å—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞ –º–æ–∂–µ—Ç —É–º–µ—Ä–µ—Ç—å —Ç–æ–ª—å–∫–æ –¥—Ä—É–≥–æ–π –ø—Ä–∏–∑—Ä–∞–∫.</p>
          </div>
          <div class="description-content" data-mode="all-ghosts">
            <h3>–ö–æ–º–ø–∞—à–∫–∞ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤</h3>
            <p>–í—Å–µ –∑–º–µ–π–∫–∏ —è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏–∑—Ä–∞–∫–∞–º–∏ —Å –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã. –•–≤–æ—Å—Ç—ã –Ω–µ–≤–∏–¥–∏–º—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Ö–∏—Ç–±–æ–∫—Å—ã. –°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Ö–≤–æ—Å—Ç–æ–≤.</p>
          </div>
          <div class="description-content" data-mode="magic-shooter">
            <h3>–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä</h3>
            <p>–° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 30% –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ —è–±–ª–æ–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–æ–µ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥: "–û—Ä—É–∂–∏–µ" (40%) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Å—Ç—Ä–µ–ª—ã —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É, "–ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å" (40%) - –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –∑–º–µ–π–∫–∏, "–î–∏–∞—Ä–µ—è" (20%) - –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –∏–≥—Ä–æ–∫ —Ç–µ—Ä—è–µ—Ç –ø–æ 1 –∫–ª–µ—Ç–∫–µ.</p>
          </div>
        </div>
      </div>
    </div>
    <div class="selected-mode-display">
      <span>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º:</span>
      <span class="mode-name" id="selected-mode-display">–ö–ª–∞—Å—Å–∏–∫–∞</span>
    </div>
    <div id="error-message"></div>
    <button id="start-controls-btn"><span>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span></button>
    <div class="instructions">
      <p>–î–æ 8 –∑–º–µ–µ–∫ –º–æ–≥—É—Ç —Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!</p>
      <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏–ª–∏ —Å–≤–∞–π–ø—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ</p>
      <p style="margin-top: 8px; font-size: 13px; color: #adb5bd;">
        –ü–∞—É–∑–∞: <kbd>Esc</kbd> / <kbd>—ë</kbd> / <kbd>`</kbd> ‚Ä¢ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω: <kbd>C</kbd>
      </p>
      <p class="ghost-info" style="margin-top: 10px; font-style: italic; color: #ff9e6d;">
        –í —Ä–µ–∂–∏–º–∞—Ö "–ü—Ä–∏–∑—Ä–∞–∫" –∏ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä" –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏
      </p>
    </div>
  </div>
  <div id="controls-screen">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞–º–∏</h2>
    <div id="controls-list" class="control-settings">
      <div class="control-row">
        <label for="control-0">–ò–≥—Ä–æ–∫ 1:</label>
        <div class="custom-select-container" id="control-0-container">
          <button class="custom-select-button" data-value="keyboard1">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¶–§–´–í)</button>
          <div class="custom-select-options">
            <div class="custom-select-option" data-value="keyboard1">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¶–§–´–í)</div>
            <div class="custom-select-option" data-value="keyboard2">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ù–ü–†–û)</div>
            <div class="custom-select-option" data-value="keyboard3">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ó–î–ñ–≠)</div>
            <div class="custom-select-option" data-value="keyboard4">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–°—Ç—Ä–µ–ª–∫–∏)</div>
            <div class="custom-select-option" data-value="swipe">–°–≤–∞–π–ø—ã</div>
          </div>
        </div>
      </div>
      <div class="control-row">
        <label for="control-1">–ò–≥—Ä–æ–∫ 2:</label>
        <div class="custom-select-container" id="control-1-container">
          <button class="custom-select-button" data-value="keyboard2">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ù–ü–†–û)</button>
          <div class="custom-select-options">
            <div class="custom-select-option" data-value="keyboard1">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¶–§–´–í)</div>
            <div class="custom-select-option" data-value="keyboard2">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ù–ü–†–û)</div>
            <div class="custom-select-option" data-value="keyboard3">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ó–î–ñ–≠)</div>
            <div class="custom-select-option" data-value="keyboard4">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–°—Ç—Ä–µ–ª–∫–∏)</div>
            <div class="custom-select-option" data-value="swipe">–°–≤–∞–π–ø—ã</div>
          </div>
        </div>
      </div>
      <div class="control-row">
        <label for="control-2">–ò–≥—Ä–æ–∫ 3:</label>
        <div class="custom-select-container" id="control-2-container">
          <button class="custom-select-button" data-value="keyboard3">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ó–î–ñ–≠)</button>
          <div class="custom-select-options">
            <div class="custom-select-option" data-value="keyboard1">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¶–§–´–í)</div>
            <div class="custom-select-option" data-value="keyboard2">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ù–ü–†–û)</div>
            <div class="custom-select-option" data-value="keyboard3">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ó–î–ñ–≠)</div>
            <div class="custom-select-option" data-value="keyboard4">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–°—Ç—Ä–µ–ª–∫–∏)</div>
            <div class="custom-select-option" data-value="swipe">–°–≤–∞–π–ø—ã</div>
          </div>
        </div>
      </div>
      <div class="control-row">
        <label for="control-3">–ò–≥—Ä–æ–∫ 4:</label>
        <div class="custom-select-container" id="control-3-container">
          <button class="custom-select-button" data-value="keyboard4">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–°—Ç—Ä–µ–ª–∫–∏)</button>
          <div class="custom-select-options">
            <div class="custom-select-option" data-value="keyboard1">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¶–§–´–í)</div>
            <div class="custom-select-option" data-value="keyboard2">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ù–ü–†–û)</div>
            <div class="custom-select-option" data-value="keyboard3">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ó–î–ñ–≠)</div>
            <div class="custom-select-option" data-value="keyboard4">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–°—Ç—Ä–µ–ª–∫–∏)</div>
            <div class="custom-select-option" data-value="swipe">–°–≤–∞–π–ø—ã</div>
          </div>
        </div>
      </div>
    </div>
    <div class="control-preview">
      <div><kbd>–¶</kbd><kbd>–§</kbd><kbd>–´</kbd><kbd>–í</kbd> / <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd></div>
      <div><kbd>–ù</kbd><kbd>–ü</kbd><kbd>–†</kbd><kbd>–û</kbd> / <kbd>Y</kbd><kbd>G</kbd><kbd>H</kbd><kbd>J</kbd></div>
      <div><kbd>–ó</kbd><kbd>–î</kbd><kbd>–ñ</kbd><kbd>–≠</kbd> / <kbd>P</kbd><kbd>L</kbd><kbd>;</kbd><kbd>'</kbd></div>
      <div><kbd>‚Üë</kbd><kbd>‚Üê</kbd><kbd>‚Üì</kbd><kbd>‚Üí</kbd></div>
    </div>
    <button id="start-btn"><span>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</span></button>
    <button id="back-btn" class="secondary"><span>–ù–∞–∑–∞–¥</span></button>
  </div>
  <div id="game-container">
    <canvas id="game-board"></canvas>
    <div id="game-over">
      <div class="game-over-content">
        <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
        <p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <span id="winner">–ù–∏—á—å—è</span></p>
        <div id="final-scores"></div>
        <button onclick="resetGame()"><span>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</span></button>
      </div>
    </div>
    <div class="pause-menu" id="pause-menu">
      <h2>–ü–∞—É–∑–∞</h2>
      <div class="pause-menu-buttons">
        <button class="pause-menu-btn" id="resume-btn"><span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span></button>
        <button class="pause-menu-btn secondary" id="main-menu-btn"><span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span></button>
      </div>
    </div>
  </div>
  <div id="scores"></div>
  <div id="legend"></div>
  <script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  const canvas = document.getElementById('game-board');
  const ctx = canvas.getContext('2d');
  const setupScreen = document.getElementById('setup-screen');
  const controlsScreen = document.getElementById('controls-screen');
  const gameContainer = document.getElementById('game-container');
  const startControlsBtn = document.getElementById('start-controls-btn');
  const startBtn = document.getElementById('start-btn');
  const backBtn = document.getElementById('back-btn');
  const errorMsg = document.getElementById('error-message');
  const scoresDiv = document.getElementById('scores');
  const legendDiv = document.getElementById('legend');
  const gameOverScreen = document.getElementById('game-over');
  const winnerDisplay = document.getElementById('winner');
  const finalScoresDiv = document.getElementById('final-scores');
  const selectedModeDisplay = document.getElementById('selected-mode-display');
  const modeIndicator = document.getElementById('mode-indicator');
  const pauseBtn = document.getElementById('pause-btn');
  const pauseMenu = document.getElementById('pause-menu');
  const resumeBtn = document.getElementById('resume-btn');
  const mainMenuBtn = document.getElementById('main-menu-btn');
  const fullscreenBtn = document.getElementById('fullscreen-btn');

  const gridSize = 20;
  const tileCountX = 60; // 1200 / 20
  const tileCountY = 30; // 600 / 20
  const MAX_PLAYERS = 8;
  const MAX_PARTICLES = 300;
  const MAX_BULLETS = 20;
  const MAX_FOODS = 8;

  // –°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã
  const gameSpeed = {
    updateInterval: 100, // –ú–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ª–æ–≥–∏–∫–∏ (10 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
    lastUpdateTime: 0
  };

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
  let snakes = [];
  let directions = [];
  let scores = [];
  let colors = [];
  let playerTypes = [];
  let botStrategies = [];
  let foods = [];
  let particles = [];
  let gameRunning = false;
  let gamePaused = false;
  let foodTimer = null;
  let totalPlayers = 0;
  let humanCount = 0;
  let playerControls = [];
  let botMemory = [];
  let lastGhostActivation = 0;

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
  let gameMode = 'classic';
  let isGhostMode = [];
  let ghostTimers = [];

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
  const SPECIAL_EFFECTS = {
    WEAPON: 0,
    INVULNERABILITY: 1,
    DIARRHEA: 2
  };

  let specialFoodTimers = [];
  let specialEffectTypes = [];
  let bullets = [];
  let diarrheaTimers = [];
  let autoShootTimers = [];

  // –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –±–æ—Ç–æ–≤
  const BOT_STRATEGIES = {
    AGGRESSIVE: 0,
    CAUTIOUS: 1,
    RANDOM: 2,
    TERRITORIAL: 3,
    HUNTER: 4
  };

  const ALL_STRATEGIES = [
    BOT_STRATEGIES.AGGRESSIVE,
    BOT_STRATEGIES.CAUTIOUS,
    BOT_STRATEGIES.RANDOM,
    BOT_STRATEGIES.TERRITORIAL,
    BOT_STRATEGIES.HUNTER
  ];

  // –¶–≤–µ—Ç–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
  const COLOR_PALETTE = [
    { head: '#4CAF50', body: '#388E3C', particle: 'hsla(120, 100%, 50%, 1)' },
    { head: '#2196F3', body: '#0D47A1', particle: 'hsla(200, 100%, 50%, 1)' },
    { head: '#FF9800', body: '#EF6C00', particle: 'hsla(40, 100%, 50%, 1)' },
    { head: '#E91E63', body: '#AD1457', particle: 'hsla(330, 100%, 50%, 1)' },
    { head: '#9C27B0', body: '#6A1B9A', particle: 'hsla(280, 100%, 50%, 1)' },
    { head: '#00BCD4', body: '#00838F', particle: 'hsla(180, 100%, 50%, 1)' },
    { head: '#FF5722', body: '#D84315', particle: 'hsla(15, 100%, 50%, 1)' },
    { head: '#666666', body: '#333333', particle: 'hsla(0, 0%, 50%, 1)' }
  ];

  // –§–£–ù–ö–¶–ò–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—ë–∑–¥–Ω–æ–≥–æ —Ñ–æ–Ω–∞
  function createStarField() {
    const bg = document.getElementById('floating-bg');
    bg.innerHTML = '';
    const starsCount = Math.floor(window.innerWidth * window.innerHeight / 5000);
    for (let i = 0; i < starsCount; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      // –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–º–µ—Ä
      const size = Math.random() * 3;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      // –°–ª—É—á–∞–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
      star.style.animationDelay = `${Math.random() * 4}s`;
      // –°–ª—É—á–∞–π–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å
      star.style.opacity = Math.random() * 0.8 + 0.2;
      bg.appendChild(star);
    }
  }

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ canvas
  function resizeCanvas() {
    const container = canvas.parentElement;
    if (!container) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
    const maxWidth = Math.min(container.clientWidth, window.innerWidth - 16);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    let maxHeight;
    if (window.innerHeight < 500 && window.matchMedia("(orientation: landscape)").matches) {
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º —ç–∫—Ä–∞–Ω–µ
      maxHeight = window.innerHeight - 50;
    } else {
      // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
      maxHeight = window.innerHeight - 120;
    }
    
    // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω 2:1
    let displayWidth = maxWidth;
    let displayHeight = displayWidth * 0.5;
    
    // –ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è, –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
    if (displayHeight > maxHeight) {
      displayHeight = maxHeight;
      displayWidth = displayHeight * 2;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ —à–∏—Ä–∏–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é
      if (displayWidth > maxWidth) {
        displayWidth = maxWidth;
        displayHeight = displayWidth * 0.5;
      }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    canvas.style.width = `${displayWidth}px`;
    canvas.style.height = `${displayHeight}px`;
    
    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    canvas.width = 1200;
    canvas.height = 600;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞
  function getStartPos(index) {
    const perimeter = [];
    for (let x = 5; x < tileCountX - 5; x += 5) perimeter.push({x, y: 5});
    for (let y = 5; y < tileCountY - 5; y += 5) perimeter.push({x: tileCountX - 6, y});
    for (let x = tileCountX - 6; x >= 5; x -= 5) perimeter.push({x, y: tileCountY - 6});
    for (let y = tileCountY - 6; y >= 5; y -= 5) perimeter.push({x: 5, y});
    return perimeter[index % perimeter.length] || {x: 10 + index * 3, y: 10};
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–∏–∑—Ä–∞–∫–æ–º
  function isPlayerGhost(playerIndex) {
    if (gameMode === 'half-ghost' || gameMode === 'family-ghost') {
      return isGhostMode[playerIndex];
    } else if (gameMode === 'full-ghost') {
      return playerIndex < humanCount;
    } else if (gameMode === 'all-ghosts') {
      return true;
    }
    return false;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ–π –∫–ª–µ—Ç–∫–∏
  function isOccupied(x, y, checkingPlayer = null) {
    for (let i = 0; i < totalPlayers; i++) {
      if (!snakes[i]) continue;
      const isGhost = isPlayerGhost(i);

      for (let j = 0; j < snakes[i].length; j++) {
        const seg = snakes[i][j];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –ø—Ä–∏–∑—Ä–∞–∫–∞
        if (isGhost && j > 0) {
          if (gameMode === 'half-ghost') {
            continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –±–µ–∑ —Ö–∏—Ç–±–æ–∫—Å–∞
          } else if (gameMode === 'family-ghost' || gameMode === 'all-ghosts') {
            // –í —ç—Ç–∏—Ö —Ä–µ–∂–∏–º–∞—Ö –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Ö–∏—Ç–±–æ–∫—Å
          } else if (gameMode === 'full-ghost') {
            // –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–∑—Ä–∞–∫–∏ –º–æ–≥—É—Ç —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å —Ö–≤–æ—Å—Ç–æ–º –ø—Ä–∏–∑—Ä–∞–∫–∞
            if (checkingPlayer !== null && isPlayerGhost(checkingPlayer)) {
              if (seg.x === x && seg.y === y) return true;
            } else {
              continue;
            }
          }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
        if (gameMode === 'magic-shooter' && specialEffectTypes[i] === SPECIAL_EFFECTS.INVULNERABILITY && i === checkingPlayer) {
          if (i !== checkingPlayer) {
            continue;
          }
        }

        if (seg.x === x && seg.y === y) return true;
      }
    }
    return false;
  }

  // –û—Ü–µ–Ω–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
  function getFreeSpace(head, dir, maxSteps = 5) {
    let pos = { x: head.x, y: head.y };
    let free = 0;
    let turns = 0;

    for (let i = 0; i < maxSteps; i++) {
      pos = {
        x: (pos.x + dir.x + tileCountX) % tileCountX,
        y: (pos.y + dir.y + tileCountY) % tileCountY
      };

      if (isOccupied(pos.x, pos.y)) break;
      free++;

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç—ã –ø–æ—Å–ª–µ 2 —à–∞–≥–æ–≤
      if (i >= 2) {
        const nextDirs = [
          { x: 0, y: -1 },
          { x: 0, y: 1 },
          { x: -1, y: 0 },
          { x: 1, y: 0 }
        ].filter(d => !(d.x === -dir.x && d.y === -dir.y));

        for (let nextDir of nextDirs) {
          const nx = (pos.x + nextDir.x + tileCountX) % tileCountX;
          const ny = (pos.y + nextDir.y + tileCountY) % tileCountY;
          if (!isOccupied(nx, ny)) turns++;
        }
      }
    }
    return { free, turns };
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ö–æ–¥–æ–≤
  function getSafeMoves(head, currentDir, isHunterActive = false) {
    const allDirs = [
      { x: 0, y: -1 }, // –≤–≤–µ—Ä—Ö
      { x: 0, y: 1 },  // –≤–Ω–∏–∑
      { x: -1, y: 0 }, // –≤–ª–µ–≤–æ
      { x: 1, y: 0 }   // –≤–ø—Ä–∞–≤–æ
    ];

    // –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const candidates = allDirs.filter(dir =>
      !(dir.x === -currentDir.x && dir.y === -currentDir.y)
    );

    const safe = [];
    const risky = [];

    for (let dir of candidates) {
      const nx = (head.x + dir.x + tileCountX) % tileCountX;
      const ny = (head.y + dir.y + tileCountY) % tileCountY;

      if (isOccupied(nx, ny)) continue;

      // –û—Ü–µ–Ω–∏–≤–∞–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏
      const space = getFreeSpace({x: nx, y: ny}, dir, 4);
      const minSpace = isHunterActive ? 1 : 2;

      if (space.free >= minSpace && space.turns > 0) {
        safe.push({ dir, space });
      } else {
        risky.push({ dir, space });
      }
    }
    return { safe, risky };
  }

  // –†–∞—Å—á–µ—Ç –º–∞–Ω—Ö—ç—Ç—Ç–µ–Ω—Å–∫–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
  function manhattan(a, b) {
    return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);
  }

  // –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –±–æ—Ç–æ–≤
  function botThink(index) {
    if (!gameRunning || snakes[index] === null) return;
    const head = snakes[index][0];
    const currentDir = directions[index];
    const strategy = botStrategies[index];
    const isHunter = strategy === BOT_STRATEGIES.HUNTER;
    const isHunterActive = isHunter && snakes[index].length >= 80;
    const reaction = isHunterActive ? 95 : (isHunter ? 100 : 80);

    // –í—ã—Å—Ç—Ä–µ–ª—ã –≤ —Ä–µ–∂–∏–º–µ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter' && specialEffectTypes[index] === SPECIAL_EFFECTS.WEAPON && Math.random() < 0.25) {
      const dir = directions[index];
      let distance = 1;
      let targetFound = false;

      while (distance <= 6 && !targetFound) {
        const checkX = (head.x + dir.x * distance + tileCountX) % tileCountX;
        const checkY = (head.y + dir.y * distance + tileCountY) % tileCountY;

        for (let i = 0; i < totalPlayers; i++) {
          if (i === index || snakes[i] === null) continue;

          for (let seg of snakes[i]) {
            if (seg.x === checkX && seg.y === checkY) {
              targetFound = true;
              break;
            }
          }
        }

        if (targetFound) {
          shootBullet(index);
        }
        distance++;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
    if (!botMemory[index]) {
      botMemory[index] = {
        lastTurn: 0,
        turnCooldown: 0,
        lastDirection: currentDir
      };
    }

    const memory = botMemory[index];
    memory.turnCooldown = Math.max(0, memory.turnCooldown - 1);

    // –ü–æ–ª—É—á–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ö–æ–¥—ã —Å —É—á–µ—Ç–æ–º –±—É–¥—É—â–∏—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
    const { safe, risky } = getSafeMoves(head, currentDir, isHunterActive);
    const candidates = safe.length > 0 ? safe : risky;

    if (candidates.length === 0) return;

    // –û—Ö–æ—Ç–Ω–∏–∫ —Å –¥–ª–∏–Ω–æ–π >= 80
    if (isHunterActive) {
      let target = null;
      let minDist = Infinity;

      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –∏–≥—Ä–æ–∫–æ–≤
      for (let i = 0; i < humanCount; i++) {
        if (snakes[i] && snakes[i][0]) {
          const dist = manhattan(head, snakes[i][0]);
          if (dist < minDist) {
            minDist = dist;
            target = snakes[i][0];
          }
        }
      }

      // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ—Ç, –æ—Ö–æ—Ç–∏–º—Å—è –Ω–∞ –±–æ—Ç–æ–≤ —Å 50% —à–∞–Ω—Å–æ–º
      if (!target && Math.random() < 0.5) {
        for (let i = humanCount; i < totalPlayers; i++) {
          if (i !== index && snakes[i] && snakes[i][0]) {
            const dist = manhattan(head, snakes[i][0]);
            if (dist < minDist) {
              minDist = dist;
              target = snakes[i][0];
            }
          }
        }
      }

      // –î–≤–∏–≥–∞–µ–º—Å—è –∫ —Ü–µ–ª–∏ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏
      if (target) {
        let bestOption = candidates[0];
        let bestScore = -Infinity;

        for (const option of candidates) {
          const nextPos = {
            x: (head.x + option.dir.x + tileCountX) % tileCountX,
            y: (head.y + option.dir.y + tileCountY) % tileCountY
          };

          // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏
          const distScore = -manhattan(nextPos, target) * 1.5;
          // –ö—Ä–∏—Ç–µ—Ä–∏–π: —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
          const spaceScore = option.space.free * 0.7 + option.space.turns * 0.8;
          // –ö—Ä–∏—Ç–µ—Ä–∏–π: —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
          const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                                 option.dir.y !== memory.lastDirection.y) ? 5 : 0;

          // –û–±—â–∏–π –±–∞–ª–ª
          const score = distScore + spaceScore + diversityScore;
          if (score > bestScore) {
            bestScore = score;
            bestOption = option;
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å
        memory.lastDirection = bestOption.dir;
        directions[index] = bestOption.dir;
        return;
      }

      // –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–∏ ‚Äî –¥–≤–∏–∂–µ–º—Å—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º
      let bestOption = candidates[0];
      let bestScore = -Infinity;

      for (const option of candidates) {
        const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                               option.dir.y !== memory.lastDirection.y) ? 10 : 0;
        const spaceScore = option.space.free * 0.8 + option.space.turns;
        const score = spaceScore + diversityScore;

        if (score > bestScore) {
          bestScore = score;
          bestOption = option;
        }
      }

      memory.lastDirection = bestOption.dir;
      directions[index] = bestOption.dir;
      return;
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã
    let targetFood = null;
    if (foods.length > 0) {
      targetFood = foods.reduce((a, b) => manhattan(head, a) < manhattan(head, b) ? a : b);
    }

    // –ï—Å–ª–∏ –µ–¥–∞ —Ä—è–¥–æ–º, –±–µ—Ä–µ–º –µ–µ
    if (targetFood && manhattan(head, targetFood) === 1) {
      const dx = targetFood.x - head.x;
      const dy = targetFood.y - head.y;
      const immediateDir = { x: dx, y: dy };

      const immediateOption = candidates.find(opt =>
        opt.dir.x === immediateDir.x && opt.dir.y === immediateDir.y
      );

      if (immediateOption) {
        memory.lastDirection = immediateOption.dir;
        directions[index] = immediateOption.dir;
        return;
      }
    }

    // –ë–∞–ª–∞–Ω—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    const isHunterInactive = isHunter && !isHunterActive;
    const isAggressive = strategy === BOT_STRATEGIES.AGGRESSIVE;
    const useGreedyFood = isHunterInactive || isAggressive;

    if (targetFood && useGreedyFood) {
      let bestOption = candidates[0];
      let bestScore = -Infinity;

      for (const option of candidates) {
        const nextPos = {
          x: (head.x + option.dir.x + tileCountX) % tileCountX,
          y: (head.y + option.dir.y + tileCountY) % tileCountY
        };

        const distScore = -manhattan(nextPos, targetFood) * 2;
        const spaceScore = option.space.free * 0.5;
        const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                               option.dir.y !== memory.lastDirection.y) ? 3 : 0;

        const score = distScore + spaceScore + diversityScore;
        if (score > bestScore) {
          bestScore = score;
          bestOption = option;
        }
      }

      memory.lastDirection = bestOption.dir;
      directions[index] = bestOption.dir;
    }
    else if (targetFood) {
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã: –æ—Ü–µ–Ω–∏–≤–∞–µ–º –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –µ–¥—ã, –∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
      let bestOption = candidates[0];
      let bestScore = -Infinity;

      for (const option of candidates) {
        const nextPos = {
          x: (head.x + option.dir.x + tileCountX) % tileCountX,
          y: (head.y + option.dir.y + tileCountY) % tileCountY
        };

        const foodScore = -manhattan(nextPos, targetFood) * 0.8;
        const spaceScore = option.space.free * 1.2 + option.space.turns * 0.7;
        const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                               option.dir.y !== memory.lastDirection.y) ? 5 : 0;

        const score = foodScore + spaceScore + diversityScore;
        if (score > bestScore) {
          bestScore = score;
          bestOption = option;
        }
      }

      memory.lastDirection = bestOption.dir;
      directions[index] = bestOption.dir;
    }
    else {
      // –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –µ–¥—ã –±–æ—Ç—ã –æ—Ö–æ—Ç—è—Ç—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏–ª–∏ –¥–≤–∏–≥–∞—é—Ç—Å—è –∏–∑–≤–∏–ª–∏—Å—Ç–æ
      const isHunting = !isHunterInactive && Math.random() < 0.8;

      if (isHunting) {
        let targetPlayer = null;
        let minDist = Infinity;

        for (let i = 0; i < humanCount; i++) {
          if (snakes[i] && snakes[i][0]) {
            const dist = manhattan(head, snakes[i][0]);
            if (dist < minDist) {
              minDist = dist;
              targetPlayer = snakes[i][0];
            }
          }
        }

        if (targetPlayer) {
          let bestOption = candidates[0];
          let bestScore = -Infinity;

          for (const option of candidates) {
            const nextPos = {
              x: (head.x + option.dir.x + tileCountX) % tileCountX,
              y: (head.y + option.dir.y + tileCountY) % tileCountY
            };

            const distScore = -manhattan(nextPos, targetPlayer) * 1.2;
            const spaceScore = option.space.free * 0.6 + option.space.turns * 0.9;
            const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                                   option.dir.y !== memory.lastDirection.y) ? 7 : 0;

            const score = distScore + spaceScore + diversityScore;
            if (score > bestScore) {
              bestScore = score;
              bestOption = option;
            }
          }

          memory.lastDirection = bestOption.dir;
          directions[index] = bestOption.dir;
          return;
        }
      }

      // –ï—Å–ª–∏ –Ω–µ –æ—Ö–æ—Ç–∏–º—Å—è –∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ—Ç ‚Äî –¥–≤–∏–≥–∞–µ–º—Å—è –∏–∑–≤–∏–ª–∏—Å—Ç–æ
      let bestOption = candidates[0];
      let bestScore = -Infinity;

      for (const option of candidates) {
        const randomFactor = Math.random() * (reaction / 50);
        const spaceScore = option.space.free * 0.9 + option.space.turns * 1.1;
        const diversityScore = (option.dir.x !== memory.lastDirection.x ||
                               option.dir.y !== memory.lastDirection.y) ? 8 : 0;

        const score = spaceScore + diversityScore + randomFactor;
        if (score > bestScore) {
          bestScore = score;
          bestOption = option;
        }
      }

      memory.lastDirection = bestOption.dir;
      directions[index] = bestOption.dir;
    }

    // –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç: –∏–Ω–æ–≥–¥–∞ –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Ö–æ—Ä–æ—à–µ–µ
    if (Math.random() < 0.15 && safe.length > 1 && memory.turnCooldown === 0) {
      const otherOptions = candidates.filter(opt =>
        !(opt.dir.x === currentDir.x && opt.dir.y === currentDir.y)
      );

      if (otherOptions.length > 0) {
        const randomOption = otherOptions[Math.floor(Math.random() * otherOptions.length)];
        memory.lastDirection = randomOption.dir;
        memory.turnCooldown = 3;
        directions[index] = randomOption.dir;
      }
    }
  }

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—á–∫–æ–≤ —Å –¥–ª–∏–Ω–æ–π —Ö–≤–æ—Å—Ç–∞
  function syncScoreWithSnakeLength() {
    for (let i = 0; i < totalPlayers; i++) {
      if (snakes[i] !== null) {
        scores[i] = (snakes[i].length - 1) * 10;
      }
    }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–¥—ã
  function generateFood() {
    if (foods.length >= MAX_FOODS || !gameRunning) return;

    let newFood;
    let overlapping;
    do {
      overlapping = false;
      newFood = {
        x: Math.floor(Math.random() * tileCountX),
        y: Math.floor(Math.random() * tileCountY),
        isSpecial: gameMode === 'magic-shooter' && Math.random() < 0.3
      };

      if (isOccupied(newFood.x, newFood.y)) overlapping = true;

      for (let f of foods) {
        if (f.x === newFood.x && f.y === newFood.y) {
          overlapping = true;
          break;
        }
      }
    } while (overlapping);

    foods.push(newFood);
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
  function createParticles(x, y, color) {
    if (particles.length > MAX_PARTICLES) return;

    const count = 12;
    for (let i = 0; i < count; i++) {
      const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
      const speed = 1 + Math.random() * 3;

      particles.push({
        x: (x + 0.5) * gridSize,
        y: (y + 0.5) * gridSize,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        life: 25,
        maxLife: 25,
        color: color
      });
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
  function drawGrid() {
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)';
    ctx.lineWidth = 1;

    for (let x = 0; x <= canvas.width; x += gridSize) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
    }

    for (let y = 0; y <= canvas.height; y += gridSize) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–º–µ–π–∫–∏
  function drawSnake(snake, headColor, bodyColor, playerIndex) {
    if (!snake) return;
    const isGhost = isPlayerGhost(playerIndex);

    for (let i = 0; i < snake.length; i++) {
      const seg = snake[i];

      // –ù–µ —Ä–∏—Å—É–µ–º —Ö–≤–æ—Å—Ç –≤ —Ä–µ–∂–∏–º–∞—Ö –ø—Ä–∏–∑—Ä–∞–∫–∞
      if (isGhost && i > 0) {
        if (gameMode === 'half-ghost' || gameMode === 'family-ghost' ||
            gameMode === 'full-ghost' || gameMode === 'all-ghosts') {
          continue;
        }
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
      let color = i === 0 ? headColor : bodyColor;

      // –≠—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
      if (gameMode === 'magic-shooter' && i === 0) {
        if (specialEffectTypes[playerIndex] === SPECIAL_EFFECTS.WEAPON) {
          color = '#FFD700';
        } else if (specialEffectTypes[playerIndex] === SPECIAL_EFFECTS.INVULNERABILITY) {
          const pulse = 0.8 + 0.2 * Math.sin(Date.now() / 100);
          color = `rgba(76, 201, 240, ${pulse})`;
        } else if (specialEffectTypes[playerIndex] === SPECIAL_EFFECTS.DIARRHEA) {
          color = '#FF6B6B';
        }
      }

      if (isGhost && i === 0) {
        // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –≥–æ–ª–æ–≤–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–∏–∑—Ä–∞–∫–∞
        if (color.startsWith('hsl')) {
          color = color.replace(')', ', 0.7)').replace('hsl', 'hsla');
        } else {
          color = 'rgba(255, 255, 255, 0.7)';
        }
      }

      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.roundRect(
        seg.x * gridSize + 1.5,
        seg.y * gridSize + 1.5,
        gridSize - 3,
        gridSize - 3,
        4
      );

      // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ç–µ–ª–∞ (–∫—Ä–æ–º–µ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–∑—Ä–∞–∫–∞)
      if (i > 0 && !isGhost) {
        const gradient = ctx.createLinearGradient(
          seg.x * gridSize,
          seg.y * gridSize,
          (seg.x + 1) * gridSize,
          (seg.y + 1) * gridSize
        );
        gradient.addColorStop(0, bodyColor);
        gradient.addColorStop(1, headColor);
        ctx.fillStyle = gradient;
      }

      ctx.fill();

      // –ì–ª–∞–∑–∞ –¥–ª—è –≥–æ–ª–æ–≤—ã
      if (i === 0) {
        ctx.fillStyle = 'white';
        ctx.beginPath();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≥–ª–∞–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const eyeOffset = 5;
        let eyeX1, eyeY1, eyeX2, eyeY2;

        if (directions[playerIndex].x === 1) { // –ü—Ä–∞–≤–æ
          eyeX1 = seg.x * gridSize + gridSize - eyeOffset;
          eyeY1 = seg.y * gridSize + eyeOffset;
          eyeX2 = seg.x * gridSize + gridSize - eyeOffset;
          eyeY2 = seg.y * gridSize + gridSize - eyeOffset;
        } else if (directions[playerIndex].x === -1) { // –õ–µ–≤–æ
          eyeX1 = seg.x * gridSize + eyeOffset;
          eyeY1 = seg.y * gridSize + eyeOffset;
          eyeX2 = seg.x * gridSize + eyeOffset;
          eyeY2 = seg.y * gridSize + gridSize - eyeOffset;
        } else if (directions[playerIndex].y === -1) { // –í–≤–µ—Ä—Ö
          eyeX1 = seg.x * gridSize + eyeOffset;
          eyeY1 = seg.y * gridSize + eyeOffset;
          eyeX2 = seg.x * gridSize + gridSize - eyeOffset;
          eyeY2 = seg.y * gridSize + eyeOffset;
        } else { // –í–Ω–∏–∑
          eyeX1 = seg.x * gridSize + eyeOffset;
          eyeY1 = seg.y * gridSize + gridSize - eyeOffset;
          eyeX2 = seg.x * gridSize + gridSize - eyeOffset;
          eyeY2 = seg.y * gridSize + gridSize - eyeOffset;
        }

        // –†–∏—Å—É–µ–º –≥–ª–∞–∑–∞
        ctx.arc(eyeX1, eyeY1, 2, 0, Math.PI * 2);
        ctx.arc(eyeX2, eyeY2, 2, 0, Math.PI * 2);
        ctx.fill();

        // –ó—Ä–∞—á–∫–∏
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(eyeX1, eyeY1, 0.8, 0, Math.PI * 2);
        ctx.arc(eyeX2, eyeY2, 0.8, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –µ–¥—ã
  function drawFood() {
    for (let f of foods) {
      const isSpecial = f.isSpecial;
      const pulseSize = isSpecial ? 6 + Math.sin(Date.now() / 150) * 3 : 4 + Math.sin(Date.now() / 200) * 2;

      // –†–∏—Å—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
      ctx.fillStyle = isSpecial ? '#9c27b0' : '#FF5252';
      ctx.beginPath();
      ctx.arc(
        (f.x + 0.5) * gridSize,
        (f.y + 0.5) * gridSize,
        pulseSize,
        0,
        Math.PI * 2
      );
      ctx.fill();

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∑–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —è–±–ª–æ–∫–∞
      if (isSpecial) {
        // –°–∏—è–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∑–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —è–±–ª–æ–∫–∞
        const glowSize = pulseSize * 1.5;
        const gradient = ctx.createRadialGradient(
          (f.x + 0.5) * gridSize, (f.y + 0.5) * gridSize, pulseSize,
          (f.x + 0.5) * gridSize, (f.y + 0.5) * gridSize, glowSize
        );
        gradient.addColorStop(0, 'rgba(156, 39, 176, 0.8)');
        gradient.addColorStop(1, 'rgba(156, 39, 176, 0)');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(
          (f.x + 0.5) * gridSize,
          (f.y + 0.5) * gridSize,
          glowSize,
          0,
          Math.PI * 2
        );
        ctx.fill();

        // –°–∏–º–≤–æ–ª –º–∞–≥–∏–∏
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('‚òÖ', (f.x + 0.5) * gridSize, (f.y + 0.5) * gridSize);
      } else {
        // –ë–ª–∏–∫ –Ω–∞ –æ–±—ã—á–Ω–æ–º —è–±–ª–æ–∫–µ
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.beginPath();
        ctx.arc(
          (f.x + 0.5) * gridSize - 1,
          (f.y + 0.5) * gridSize - 1,
          1.5,
          0,
          Math.PI * 2
        );
        ctx.fill();
      }
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawGrid();

    // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã
    for (let p of particles) {
      const alpha = p.life / p.maxLife;
      let color;

      if (p.color.includes('hsla')) {
        color = p.color.replace(/[\d.]+\)$/, `${alpha})`);
      } else if (p.color.includes('hsl')) {
        color = p.color.replace(')', `, ${alpha})`).replace('hsl', 'hsla');
      } else {
        color = p.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
      }

      // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —á–∞—Å—Ç–∏—Ü
      const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 3);
      gradient.addColorStop(0, color);
      gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
      ctx.fill();
    }

    // –†–∏—Å—É–µ–º –∑–º–µ–µ–∫
    for (let i = 0; i < totalPlayers; i++) {
      if (snakes[i] !== null) {
        drawSnake(snakes[i], colors[i].head, colors[i].body, i);
      }
    }

    drawFood();

    // –†–∏—Å—É–µ–º –ø—É–ª–∏ –≤ —Ä–µ–∂–∏–º–µ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      drawBullets();
    }
  }

  // –†–µ–∂–∏–º "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
  function shootBullet(playerIndex) {
    if (bullets.length > MAX_BULLETS || !gameRunning ||
        specialEffectTypes[playerIndex] !== SPECIAL_EFFECTS.WEAPON) return;

    const head = snakes[playerIndex][0];
    const direction = directions[playerIndex];

    // –°–æ–∑–¥–∞–µ–º –ø—É–ª—é
    const bullet = {
      x: head.x,
      y: head.y,
      vx: direction.x * 3,
      vy: direction.y * 3,
      owner: playerIndex,
      life: 20,
      framesAlive: 0
    };

    bullets.push(bullet);

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –≤—ã—Å—Ç—Ä–µ–ª–∞
    createParticles(head.x, head.y, '#FFD700');

    // –ó–≤—É–∫–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (–≤–∏–±—Ä–∞—Ü–∏—è)
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  }

  function updateBullets() {
    if (bullets.length > MAX_BULLETS) {
      bullets = bullets.slice(-MAX_BULLETS);
    }

    for (let i = bullets.length - 1; i >= 0; i--) {
      const bullet = bullets[i];

      // –î–≤–∏–∂–µ–Ω–∏–µ –ø—É–ª–∏
      bullet.x += bullet.vx;
      bullet.y += bullet.vy;
      bullet.life--;
      bullet.framesAlive++;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
      if (bullet.x < 0 || bullet.x >= tileCountX || bullet.y < 0 || bullet.y >= tileCountY) {
        bullets.splice(i, 1);
        continue;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∑–º–µ–π–∫—É
      for (let j = 0; j < totalPlayers; j++) {
        if (snakes[j] === null) continue;

        for (let k = 0; k < snakes[j].length; k++) {
          const seg = snakes[j][k];

          if (seg.x === Math.floor(bullet.x) && seg.y === Math.floor(bullet.y)) {
            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ! –£–∫–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–º–µ–π–∫—É
            if (snakes[j].length > 1 && bullet.owner !== j) {
              snakes[j].pop();
              createParticles(seg.x, seg.y, colors[bullet.owner].particle);
            }

            // –ï—Å–ª–∏ –ø—É–ª—è –ø–æ–ø–∞–ª–∞ –≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –∏ –æ–Ω–∞ –ª–µ—Ç–µ–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–ª–≥–æ
            if (bullet.owner === j && bullet.framesAlive > 5 && snakes[j].length > 1) {
              snakes[j].pop();
              createParticles(seg.x, seg.y, '#FF6B6B');
            }

            // –£–¥–∞–ª—è–µ–º –ø—É–ª—é
            bullets.splice(i, 1);
            break;
          }
        }
      }

      // –£–¥–∞–ª—è–µ–º –ø—É–ª—é, –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–æ—à–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
      if (bullet.life <= 0) {
        bullets.splice(i, 1);
      }
    }
  }

  function drawBullets() {
    for (let bullet of bullets) {
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.arc(
        (bullet.x + 0.5) * gridSize,
        (bullet.y + 0.5) * gridSize,
        4,
        0,
        Math.PI * 2
      );

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥
      const trailGradient = ctx.createRadialGradient(
        (bullet.x + 0.5) * gridSize, (bullet.y + 0.5) * gridSize, 2,
        (bullet.x + 0.5) * gridSize, (bullet.y + 0.5) * gridSize, 8
      );
      trailGradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
      trailGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
      ctx.fillStyle = trailGradient;
      ctx.arc(
        (bullet.x + 0.5) * gridSize,
        (bullet.y + 0.5) * gridSize,
        8,
        0,
        Math.PI * 2
      );
      ctx.fill();
    }
  }

  function applySpecialEffect(playerIndex) {
    if (!gameRunning || gameMode !== 'magic-shooter') return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç—Ñ—Ñ–µ–∫—Ç–∞
    const random = Math.random();
    let effectType;

    if (random < 0.4) {
      effectType = SPECIAL_EFFECTS.WEAPON;
    } else if (random < 0.8) {
      effectType = SPECIAL_EFFECTS.INVULNERABILITY;
    } else {
      effectType = SPECIAL_EFFECTS.DIARRHEA;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç
    specialEffectTypes[playerIndex] = effectType;
    specialFoodTimers[playerIndex] = Date.now() + 10000;

    // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é
    const effectColors = {
      [SPECIAL_EFFECTS.WEAPON]: '#FFD700',
      [SPECIAL_EFFECTS.INVULNERABILITY]: '#4CC9F0',
      [SPECIAL_EFFECTS.DIARRHEA]: '#FF6B6B'
    };

    createParticles(snakes[playerIndex][0].x, snakes[playerIndex][0].y, effectColors[effectType]);

    // –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç "–î–∏–∞—Ä–µ—è", –Ω–∞—á–∏–Ω–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Ç–µ—Ä–∏ –∫–ª–µ—Ç–æ–∫
    if (effectType === SPECIAL_EFFECTS.DIARRHEA) {
      if (diarrheaTimers[playerIndex]) {
        clearInterval(diarrheaTimers[playerIndex]);
      }

      diarrheaTimers[playerIndex] = setInterval(() => {
        if (snakes[playerIndex] && snakes[playerIndex].length > 1 &&
            specialEffectTypes[playerIndex] === SPECIAL_EFFECTS.DIARRHEA) {
          const tail = snakes[playerIndex][snakes[playerIndex].length - 1];
          snakes[playerIndex].pop();
          createParticles(tail.x, tail.y, '#FF6B6B');
        }
      }, 5000);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞
    showEffectIndicator(playerIndex, effectType);
  }

  function showEffectIndicator(playerIndex, effectType) {
    let effectNames = {
      [SPECIAL_EFFECTS.WEAPON]: "–û—Ä—É–∂–∏–µ",
      [SPECIAL_EFFECTS.INVULNERABILITY]: "–ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å",
      [SPECIAL_EFFECTS.DIARRHEA]: "–î–∏–∞—Ä–µ—è"
    };

    let icons = {
      [SPECIAL_EFFECTS.WEAPON]: "üî´",
      [SPECIAL_EFFECTS.INVULNERABILITY]: "üõ°Ô∏è",
      [SPECIAL_EFFECTS.DIARRHEA]: "üíß"
    };

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    const existingIndicator = document.querySelector(`.effect-indicator`);
    if (existingIndicator) {
      existingIndicator.remove();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    let effectIndicator = document.createElement('div');
    effectIndicator.className = 'effect-indicator';
    effectIndicator.innerHTML = `
      <span class="effect-icon">${icons[effectType]}</span>
      <span>${effectNames[effectType]} –¥–ª—è ${playerTypes[playerIndex] === 'bot' ? '–ë–æ—Ç–∞' : '–ò–≥—Ä–æ–∫–∞'} ${playerIndex + 1}</span>
      <span class="effect-timer">10 —Å–µ–∫</span>
    `;

    document.body.appendChild(effectIndicator);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
    let remainingTime = 10;
    const timerInterval = setInterval(() => {
      remainingTime--;
      const timerElement = effectIndicator.querySelector('.effect-timer');

      if (timerElement) {
        timerElement.textContent = `${remainingTime} —Å–µ–∫`;
      }

      if (remainingTime <= 0 || specialEffectTypes[playerIndex] !== effectType) {
        clearInterval(timerInterval);
        if (effectIndicator.parentNode) {
          effectIndicator.parentNode.removeChild(effectIndicator);
        }
      }
    }, 1000);

    // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      if (effectIndicator.parentNode) {
        effectIndicator.parentNode.removeChild(effectIndicator);
      }
      clearInterval(timerInterval);
    }, 10000);
  }

  function checkInvulnerabilityEnd(playerIndex) {
    if (specialEffectTypes[playerIndex] !== SPECIAL_EFFECTS.INVULNERABILITY) return;

    const head = snakes[playerIndex][0];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –∑–º–µ–π–∫–∞–º–∏ –∏–ª–∏ —Å —Å–æ–±–æ–π
    if (isOccupied(head.x, head.y, playerIndex)) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ, –æ–±—Ä–µ–∑–∞–µ–º –∑–º–µ–π–∫—É –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
      let collisionIndex = -1;

      for (let i = 1; i < snakes[playerIndex].length; i++) {
        const seg = snakes[playerIndex][i];

        if (isOccupied(seg.x, seg.y, playerIndex)) {
          collisionIndex = i;
          break;
        }
      }

      if (collisionIndex > 0) {
        // –û–±—Ä–µ–∑–∞–µ–º –∑–º–µ–π–∫—É
        const removedSegments = snakes[playerIndex].splice(0, collisionIndex);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ä–µ–∑–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∫–∞–∫ —è–±–ª–æ–∫–∏
        for (let seg of removedSegments) {
          foods.push({ x: seg.x, y: seg.y });
        }

        createExplosion(snakes[playerIndex][0].x, snakes[playerIndex][0].y, colors[playerIndex].particle);
      }
    }
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ "–ü—Ä–∏–∑—Ä–∞–∫"
  function manageGhostMode() {
    if (!gameRunning) return;

    if (gameMode === 'half-ghost' || gameMode === 'family-ghost') {
      const now = Date.now();

      // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–∑—Ä–∞–∫–∞ —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
      if (now - lastGhostActivation > 10000 && Math.random() < 0.1) {
        activateRandomGhostMode();
        lastGhostActivation = now;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–∑—Ä–∞–∫–∞
      const maxPlayers = gameMode === 'family-ghost' ? totalPlayers : humanCount;

      for (let i = 0; i < maxPlayers; i++) {
        if (isGhostMode[i] && ghostTimers[i] && now >= ghostTimers[i]) {
          deactivateGhostMode(i);
        }
      }
    }
  }

  function activateRandomGhostMode() {
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∂–∏–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    const alivePlayers = [];
    const maxPlayers = gameMode === 'family-ghost' ? totalPlayers : humanCount;

    for (let i = 0; i < maxPlayers; i++) {
      if (snakes[i] !== null) alivePlayers.push(i);
    }

    if (alivePlayers.length === 0) return;

    const randomPlayer = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
    activateGhostMode(randomPlayer);
  }

  function activateGhostMode(playerIndex) {
    isGhostMode[playerIndex] = true;
    ghostTimers[playerIndex] = Date.now() + 5000;

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    if (snakes[playerIndex] && snakes[playerIndex][0]) {
      createParticles(snakes[playerIndex][0].x, snakes[playerIndex][0].y, colors[playerIndex].particle);
    }

    // –ó–≤—É–∫–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (–≤–∏–±—Ä–∞—Ü–∏—è)
    if (navigator.vibrate) {
      navigator.vibrate([50, 30, 50]);
    }

    updateScoreDisplay();
    updateModeIndicator();
  }

  function deactivateGhostMode(playerIndex) {
    isGhostMode[playerIndex] = false;
    ghostTimers[playerIndex] = null;

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    if (snakes[playerIndex] && snakes[playerIndex][0]) {
      createParticles(snakes[playerIndex][0].x, snakes[playerIndex][0].y, colors[playerIndex].particle);
    }

    updateScoreDisplay();
    updateModeIndicator();
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
  function updateModeIndicator() {
    if (!gameRunning) return;

    if (gameMode === 'half-ghost' || gameMode === 'family-ghost') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–∑—Ä–∞–∫–∏
      let activeGhost = false;

      for (let i = 0; i < (gameMode === 'family-ghost' ? totalPlayers : humanCount); i++) {
        if (isGhostMode[i]) {
          activeGhost = true;
          break;
        }
      }

      if (activeGhost) {
        modeIndicator.textContent = 'üëª –†–µ–∂–∏–º –ø—Ä–∏–∑—Ä–∞–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω!';
        modeIndicator.style.display = 'block';
        modeIndicator.style.backgroundColor = 'rgba(156, 39, 176, 0.9)';
      } else {
        modeIndicator.style.display = 'none';
      }
    } else if (gameMode === 'full-ghost' || gameMode === 'all-ghosts') {
      modeIndicator.textContent = 'üëª –†–µ–∂–∏–º –ø—Ä–∏–∑—Ä–∞–∫–∞';
      modeIndicator.style.display = 'block';
      modeIndicator.style.backgroundColor = 'rgba(156, 39, 176, 0.9)';
    } else if (gameMode === 'magic-shooter') {
      modeIndicator.textContent = '‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä';
      modeIndicator.style.display = 'block';
      modeIndicator.style.backgroundColor = 'rgba(255, 215, 0, 0.9)';
    } else {
      modeIndicator.style.display = 'none';
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–∫–æ–≤
  function updateScoreDisplay() {
    scoresDiv.innerHTML = '';
    legendDiv.innerHTML = '';

    for (let i = 0; i < totalPlayers; i++) {
      if (scores[i] > 0 || (playerTypes[i] === 'human' && i < humanCount)) {
        const name = playerTypes[i] === 'bot' ? `–ë–æ—Ç ${i - humanCount + 1}` : `–ò–≥—Ä–æ–∫ ${i + 1}`;
        const scoreEl = document.createElement('div');
        const isDead = snakes[i] === null;

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
        const indicator = document.createElement('span');
        indicator.className = 'player-indicator';
        indicator.style.backgroundColor = colors[i].head;
        if (isDead) {
          indicator.style.opacity = '0.5';
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–∑—Ä–∞–∫–∞, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–∏–∑—Ä–∞–∫–∞
        let ghostIndicator = '';
        if (isPlayerGhost(i)) {
          ghostIndicator = '<span class="ghost-indicator"></span>';
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–º–µ—Ä—Ç–∏
        let deathIndicator = '';
        if (isDead) {
          deathIndicator = ' <span style="color: #f72585; font-size: 16px;" title="–ú—ë—Ä—Ç–≤">üíÄ</span>';
        }

        scoreEl.innerHTML = `${indicator.outerHTML} ${name}: <strong>${scores[i]}</strong>${ghostIndicator}${deathIndicator}`;
        
        if (isDead) {
          scoreEl.style.opacity = '0.7';
          scoreEl.style.textDecoration = 'line-through';
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ —à—É—Ç–µ—Ä–∞
        if (gameMode === 'magic-shooter' && specialEffectTypes[i] !== null && !isDead) {
          const effectIcon = document.createElement('span');
          effectIcon.style.marginLeft = '5px';
          effectIcon.style.fontSize = '16px';

          switch (specialEffectTypes[i]) {
            case SPECIAL_EFFECTS.WEAPON:
              effectIcon.textContent = 'üî´';
              effectIcon.title = '–û—Ä—É–∂–∏–µ';
              break;
            case SPECIAL_EFFECTS.INVULNERABILITY:
              effectIcon.textContent = 'üõ°Ô∏è';
              effectIcon.title = '–ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å';
              break;
            case SPECIAL_EFFECTS.DIARRHEA:
              effectIcon.textContent = 'üíß';
              effectIcon.title = '–î–∏–∞—Ä–µ—è';
              break;
          }

          scoreEl.appendChild(effectIcon);
        }

        scoresDiv.appendChild(scoreEl);

        const colorBox = document.createElement('div');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = colors[i].head;
        if (isDead) {
          colorBox.style.opacity = '0.5';
        }

        const label = document.createElement('span');
        label.textContent = name;
        if (isDead) {
          label.style.opacity = '0.7';
          label.style.textDecoration = 'line-through';
        }

        const item = document.createElement('div');
        item.className = 'legend-item';
        item.appendChild(colorBox);
        item.appendChild(label);

        legendDiv.appendChild(item);
      }
    }
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∑—Ä—ã–≤–∞
  function createExplosion(x, y, color) {
    if (particles.length > MAX_PARTICLES) return;

    const count = 25;
    for (let i = 0; i < count; i++) {
      const angle = (Math.PI * 2 * i) / count + Math.random() * 0.3;
      const speed = 2 + Math.random() * 5;

      particles.push({
        x: (x + 0.5) * gridSize,
        y: (y + 0.5) * gridSize,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        life: 30,
        maxLife: 30,
        color: color
      });
    }
  }

  // –£–±–∏–π—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–∞
  function killPlayer(index) {
    if (snakes[index] === null) return;

    for (let seg of snakes[index]) {
      foods.push({ x: seg.x, y: seg.y });
    }

    snakes[index] = null;
    directions[index] = null;
    botMemory[index] = null;

    // –û—á–∏—â–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —É–±–∏—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    if (gameMode === 'magic-shooter') {
      specialEffectTypes[index] = null;
      specialFoodTimers[index] = null;

      if (diarrheaTimers[index]) {
        clearInterval(diarrheaTimers[index]);
        diarrheaTimers[index] = null;
      }

      if (autoShootTimers[index]) {
        clearInterval(autoShootTimers[index]);
        autoShootTimers[index] = null;
      }
    }

    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –ø—Ä–∏–∑—Ä–∞–∫–∞
    if (ghostTimers[index]) {
      ghostTimers[index] = null;
    }

    updateScoreDisplay();
    updateModeIndicator();
  }

  // –û–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
  function endGame() {
    gameRunning = false;

    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
    if (foodTimer) {
      clearInterval(foodTimer);
      foodTimer = null;
    }

    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      for (let i = 0; i < MAX_PLAYERS; i++) {
        if (diarrheaTimers[i]) {
          clearInterval(diarrheaTimers[i]);
          diarrheaTimers[i] = null;
        }

        if (autoShootTimers[i]) {
          clearInterval(autoShootTimers[i]);
          autoShootTimers[i] = null;
        }
      }
    }

    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
    for (let i = 0; i < MAX_PLAYERS; i++) {
      if (ghostTimers[i]) {
        ghostTimers[i] = null;
      }
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    finalScoresDiv.innerHTML = '';
    const entries = [];

    for (let i = 0; i < totalPlayers; i++) {
      if (scores[i] >= 0) {
        const score = scores[i];
        const name = playerTypes[i] === 'bot'
          ? `–ë–æ—Ç ${i - humanCount + 1}`
          : `–ò–≥—Ä–æ–∫ ${i + 1}`;
        const color = colors[i].head;
        const isAlive = snakes[i] !== null;

        entries.push({ score, name, color, isAlive });
      }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º
    entries.sort((a, b) => b.score - a.score);

    entries.forEach(entry => {
      const html = `<div style="color: ${entry.color}">${entry.name}${entry.isAlive ? ' (–∂–∏–≤)' : ''}: ${entry.score}</div>`;
      finalScoresDiv.innerHTML += html;
    });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    let aliveHumans = [];
    let aliveBots = [];

    for (let i = 0; i < totalPlayers; i++) {
      if (snakes[i] !== null) {
        if (playerTypes[i] === 'human') aliveHumans.push(`–ò–≥—Ä–æ–∫ ${i + 1}`);
        else aliveBots.push(`–ë–æ—Ç ${i - humanCount + 1}`);
      }
    }

    if (aliveHumans.length > 0) {
      winnerDisplay.textContent = aliveHumans.length === 1 ? aliveHumans[0] : `–ò–≥—Ä–æ–∫–∏: ${aliveHumans.join(', ')}`;
    } else if (aliveBots.length > 0) {
      winnerDisplay.textContent = '–ë–æ—Ç—ã –ø–æ–±–µ–¥–∏–ª–∏!';
    } else {
      winnerDisplay.textContent = '–ù–∏—á—å—è';
    }

    setTimeout(() => gameOverScreen.classList.add('active'), 300);

    // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–º–µ–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  function canChangeDirection(currentDir, newDir) {
    return !(currentDir.x === -newDir.x && currentDir.y === -newDir.y);
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  function setupControls() {
    document.removeEventListener('keydown', handleKeyDown);
    canvas.removeEventListener('touchstart', handleTouchStart);
    canvas.removeEventListener('touchend', handleTouchEnd);

    document.addEventListener('keydown', handleKeyDown);
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
  function handleKeyDown(e) {
    if (!gameRunning) return;

    for (let i = 0; i < humanCount; i++) {
      if (snakes[i] === null) continue;

      const control = playerControls[i];
      let dir = null;

      if (control === 'keyboard1') {
        // –†—É—Å—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ –¶–§–´–í
        if (e.key === '—Ü' || e.key === '–¶') dir = { x: 0, y: -1 };
        else if (e.key === '—ã' || e.key === '–´') dir = { x: 0, y: 1 };
        else if (e.key === '—Ñ' || e.key === '–§') dir = { x: -1, y: 0 };
        else if (e.key === '–≤' || e.key === '–í') dir = { x: 1, y: 0 };
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ WASD
        else if (e.key === 'w' || e.key === 'W') dir = { x: 0, y: -1 };
        else if (e.key === 's' || e.key === 'S') dir = { x: 0, y: 1 };
        else if (e.key === 'a' || e.key === 'A') dir = { x: -1, y: 0 };
        else if (e.key === 'd' || e.key === 'D') dir = { x: 1, y: 0 };
      } else if (control === 'keyboard2') {
        // –†—É—Å—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ –ù–ü–†–û
        if (e.key === '–Ω' || e.key === '–ù') dir = { x: 0, y: -1 };
        else if (e.key === '—Ä' || e.key === '–†') dir = { x: 0, y: 1 };
        else if (e.key === '–ø' || e.key === '–ü') dir = { x: -1, y: 0 };
        else if (e.key === '–æ' || e.key === '–û') dir = { x: 1, y: 0 };
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ YGHJ
        else if (e.key === 'y' || e.key === 'Y') dir = { x: 0, y: -1 };
        else if (e.key === 'h' || e.key === 'H') dir = { x: 0, y: 1 };
        else if (e.key === 'g' || e.key === 'G') dir = { x: -1, y: 0 };
        else if (e.key === 'j' || e.key === 'J') dir = { x: 1, y: 0 };
      } else if (control === 'keyboard3') {
        // –†—É—Å—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ –ó–î–ñ–≠
        if (e.key === '–∑' || e.key === '–ó') dir = { x: 0, y: -1 };
        else if (e.key === '–∂' || e.key === '–ñ') dir = { x: 0, y: 1 };
        else if (e.key === '–¥' || e.key === '–î') dir = { x: -1, y: 0 };
        else if (e.key === '—ç' || e.key === '–≠') dir = { x: 1, y: 0 };
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ PL√ñ√Ñ (–∏–ª–∏ PL;')
        else if (e.key === 'p' || e.key === 'P') dir = { x: 0, y: -1 };
        else if (e.key === ';' || e.key === ':') dir = { x: 0, y: 1 };
        else if (e.key === 'l' || e.key === 'L') dir = { x: -1, y: 0 };
        else if (e.key === "'" || e.key === '"') dir = { x: 1, y: 0 };
      } else if (control === 'keyboard4') {
        if (e.key === 'ArrowUp') dir = { x: 0, y: -1 };
        else if (e.key === 'ArrowDown') dir = { x: 0, y: 1 };
        else if (e.key === 'ArrowLeft') dir = { x: -1, y: 0 };
        else if (e.key === 'ArrowRight') dir = { x: 1, y: 0 };
      }

      if (dir && canChangeDirection(directions[i], dir)) {
        directions[i] = dir;

        // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–∫—Ç–∏–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        if (navigator.vibrate && isMobile) {
          navigator.vibrate(20);
        }
      }
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
  let touchStart = {};
  let currentTouchPlayer = -1;
  let lastTap = 0;

  function handleTouchStart(e) {
    if (!gameRunning) return;

    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    const zoneX = x < rect.width / 2 ? 0 : 1;
    const zoneY = y < rect.height / 2 ? 0 : 1;
    const zone = zoneY * 2 + zoneX;

    if (playerControls[zone] === 'swipe' && zone < humanCount) {
      currentTouchPlayer = zone;
      touchStart.x = x;
      touchStart.y = y;
      e.preventDefault();
    }
  }

  function handleTouchEnd(e) {
    if (!gameRunning || currentTouchPlayer === -1) return;

    const touch = e.changedTouches[0];
    const rect = canvas.getBoundingClientRect();
    const endX = touch.clientX - rect.left;
    const endY = touch.clientY - rect.top;
    const dx = endX - touchStart.x;
    const dy = endY - touchStart.y;

    if (Math.abs(dx) < 30 && Math.abs(dy) < 30) {
      currentTouchPlayer = -1;
      return;
    }

    let dir = null;

    if (Math.abs(dx) > Math.abs(dy)) {
      dir = dx > 0 ? { x: 1, y: 0 } : { x: -1, y: 0 };
    } else {
      dir = dy > 0 ? { x: 0, y: 1 } : { x: 0, y: -1 };
    }

    if (dir && canChangeDirection(directions[currentTouchPlayer], dir)) {
      directions[currentTouchPlayer] = dir;

      // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
      if (navigator.vibrate) {
        navigator.vibrate(30);
      }
    }

    currentTouchPlayer = -1;
    e.preventDefault();
  }

  // –§—É–Ω–∫—Ü–∏–∏ –ø–∞—É–∑—ã
  function pauseGame() {
    if (!gameRunning || gamePaused) return;
    gamePaused = true;
    pauseMenu.classList.add('active');
    pauseBtn.textContent = '‚ñ∂';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
    setTimeout(() => {
      resumeBtn.focus();
    }, 100);
  }

  function resumeGame() {
    if (!gameRunning || !gamePaused) return;
    gamePaused = false;
    pauseMenu.classList.remove('active');
    pauseBtn.textContent = '‚è∏';
    gameSpeed.lastUpdateTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∫–∞—á–∫–∞
  }

  function togglePause() {
    if (gamePaused) {
      resumeGame();
    } else {
      pauseGame();
    }
  }

  function returnToMainMenu() {
    gamePaused = false;
    pauseMenu.classList.remove('active');
    resetGame();
  }

  // –§—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
  function toggleFullscreen() {
    if (!document.fullscreenElement && !document.webkitFullscreenElement && 
        !document.mozFullScreenElement && !document.msFullscreenElement) {
      // –í—Ö–æ–¥–∏–º –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    } else {
      // –í—ã—Ö–æ–¥–∏–º –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  }

  function updateFullscreenButton() {
    if (document.fullscreenElement || document.webkitFullscreenElement || 
        document.mozFullScreenElement || document.msFullscreenElement) {
      fullscreenBtn.textContent = '‚õ∂';
      fullscreenBtn.title = '–í—ã–π—Ç–∏ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (C)';
    } else {
      fullscreenBtn.textContent = '‚õ∂';
      fullscreenBtn.title = '–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (C)';
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –∞–Ω–∏–º–∞—Ü–∏—è
  function update() {
    if (!gameRunning || gamePaused) return;

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤
    if (particles.length > MAX_PARTICLES) {
      particles = particles.slice(-MAX_PARTICLES);
    }

    if (bullets.length > MAX_BULLETS) {
      bullets = bullets.slice(-MAX_BULLETS);
    }

    if (foods.length > MAX_FOODS) {
      foods = foods.slice(-MAX_FOODS);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      const now = Date.now();

      for (let i = 0; i < totalPlayers; i++) {
        if (specialFoodTimers[i] && now >= specialFoodTimers[i]) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
          if (specialEffectTypes[i] === SPECIAL_EFFECTS.INVULNERABILITY) {
            checkInvulnerabilityEnd(i);
          }

          // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–∏–∞—Ä–µ–∏
          if (specialEffectTypes[i] === SPECIAL_EFFECTS.DIARRHEA && diarrheaTimers[i]) {
            clearInterval(diarrheaTimers[i]);
            diarrheaTimers[i] = null;
          }

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç
          specialEffectTypes[i] = null;
          specialFoodTimers[i] = null;
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É–ª–∏
      updateBullets();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–∏–º—ã –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
    if (gameMode === 'half-ghost' || gameMode === 'family-ghost') {
      manageGhostMode();
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –±–æ—Ç–æ–≤
    for (let i = 0; i < totalPlayers; i++) {
      if (playerTypes[i] === 'bot' && snakes[i] !== null) {
        botThink(i);
      }
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–º–µ–µ–∫
    for (let i = 0; i < totalPlayers; i++) {
      if (snakes[i] === null) continue;

      const head = {
        x: (snakes[i][0].x + directions[i].x + tileCountX) % tileCountX,
        y: (snakes[i][0].y + directions[i].y + tileCountY) % tileCountY
      };

      let shouldKill = true;

      // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –¥–ª—è —Ä–µ–∂–∏–º–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ —à—É—Ç–µ—Ä–∞
      if (gameMode === 'magic-shooter' && specialEffectTypes[i] === SPECIAL_EFFECTS.INVULNERABILITY) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è –ª–∏ –≥–æ–ª–æ–≤–∞ —Å –¥—Ä—É–≥–∏–º–∏ –∑–º–µ–π–∫–∞–º–∏
        for (let j = 0; j < totalPlayers; j++) {
          if (j === i || snakes[j] === null) continue;

          for (let seg of snakes[j]) {
            if (seg.x === head.x && seg.y === head.y) {
              // –ï—Å–ª–∏ —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è —Å –¥—Ä—É–≥–æ–π –∑–º–µ–π–∫–æ–π, —É–º–∏—Ä–∞–µ—Ç –¥—Ä—É–≥–∞—è –∑–º–µ–π–∫–∞
              createExplosion(seg.x, seg.y, colors[i].particle);
              killPlayer(j);
              shouldKill = false;
              break;
            }
          }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
        for (let k = 1; k < snakes[i].length; k++) {
          const seg = snakes[i][k];

          if (seg.x === head.x && seg.y === head.y) {
            shouldKill = true;
            break;
          }
        }
      } else {
        // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        if (isOccupied(head.x, head.y, i)) {
          createExplosion(head.x, head.y, colors[i].particle);
          killPlayer(i);
          continue;
        }
      }

      if (shouldKill && isOccupied(head.x, head.y, i)) {
        createExplosion(head.x, head.y, colors[i].particle);
        killPlayer(i);
        continue;
      }

      snakes[i].unshift(head);
      let ate = false;

      const isHunter = botStrategies[i] === BOT_STRATEGIES.HUNTER && snakes[i].length >= 80;

      if (!isHunter) {
        for (let j = 0; j < foods.length; j++) {
          if (foods[j].x === head.x && foods[j].y === head.y) {
            if (gameMode === 'magic-shooter' && foods[j].isSpecial) {
              // –°—ä–µ–ª–∏ –∑–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–æ–µ —è–±–ª–æ–∫–æ
              applySpecialEffect(i);
            } else {
              // –°—ä–µ–ª–∏ –æ–±—ã—á–Ω–æ–µ —è–±–ª–æ–∫–æ
            }

            createParticles(foods[j].x, foods[j].y, colors[i].particle);
            foods.splice(j, 1);
            ate = true;
            break;
          }
        }
      }

      if (!ate) snakes[i].pop();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—á–∫–æ–≤
    syncScoreWithSnakeLength();
    updateScoreDisplay();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
    let aliveHumans = 0;
    let aliveBots = 0;

    for (let i = 0; i < totalPlayers; i++) {
      if (snakes[i] !== null) {
        if (playerTypes[i] === 'human') aliveHumans++;
        else aliveBots++;
      }
    }

    const aliveTotal = aliveHumans + aliveBots;

    if (aliveTotal === 0 || (totalPlayers > 1 && aliveTotal === 1) || (aliveHumans === 0 && aliveBots > 0)) {
      endGame();
      return;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
    particles = particles.filter(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.life--;
      return p.life > 0;
    });
  }

  function gameLoop() {
    update();
    draw();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–µ–ª—å–±—ã
  function setupAutoShoot() {
    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–π–º–µ—Ä—ã
    autoShootTimers.forEach(timer => {
      if (timer) clearInterval(timer);
    });

    autoShootTimers = new Array(MAX_PLAYERS).fill(null);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    for (let i = 0; i < totalPlayers; i++) {
      autoShootTimers[i] = setInterval(() => {
        if (gameRunning && snakes[i] !== null &&
            specialEffectTypes[i] === SPECIAL_EFFECTS.WEAPON) {
          shootBullet(i);
        }
      }, 1500);
    }
  }

  // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
  function startGame(humans, bots) {
    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–≥—Ä—ã
    resetGame();

    totalPlayers = humans + bots;
    setupScreen.style.display = 'none';
    controlsScreen.style.display = 'none';
    gameContainer.style.display = 'block';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã
    pauseBtn.style.display = 'block';
    pauseBtn.textContent = '‚è∏';

    resizeCanvas();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–∞—Å—Å–∏–≤–æ–≤
    snakes = [];
    directions = [];
    scores = [];
    colors = [];
    playerTypes = [];
    botStrategies = [];
    foods = [];
    particles = [];
    bullets = [];
    botMemory = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ "–ü—Ä–∏–∑—Ä–∞–∫"
    isGhostMode = new Array(MAX_PLAYERS).fill(false);
    ghostTimers = new Array(MAX_PLAYERS).fill(null);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      specialFoodTimers = new Array(MAX_PLAYERS).fill(null);
      specialEffectTypes = new Array(MAX_PLAYERS).fill(null);
      diarrheaTimers = new Array(MAX_PLAYERS).fill(null);
      autoShootTimers = new Array(MAX_PLAYERS).fill(null);
      bullets = [];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–∫–æ–≤
    for (let i = 0; i < totalPlayers; i++) {
      const startPos = getStartPos(i);
      let initialDir;

      if (startPos.x < 10) initialDir = { x: 1, y: 0 };
      else if (startPos.x > tileCountX - 10) initialDir = { x: -1, y: 0 };
      else if (startPos.y < 10) initialDir = { x: 0, y: 1 };
      else if (startPos.y > tileCountY - 10) initialDir = { x: 0, y: -1 };
      else initialDir = { x: 1, y: 0 };

      snakes.push([startPos]);
      directions.push(initialDir);
      colors.push(COLOR_PALETTE[i % COLOR_PALETTE.length]);

      if (i < humans) {
        playerTypes.push('human');
        botStrategies.push(null);
        botMemory.push(null);
      } else {
        playerTypes.push('bot');
        const randomStrategy = ALL_STRATEGIES[Math.floor(Math.random() * ALL_STRATEGIES.length)];
        botStrategies.push(randomStrategy);
        botMemory.push(null);
      }

      scores.push(0);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–æ–≤ "–ü—Ä–∏–∑—Ä–∞–∫"
    if (gameMode === 'full-ghost' || gameMode === 'all-ghosts') {
      for (let i = 0; i < totalPlayers; i++) {
        if (gameMode === 'full-ghost' && i < humanCount) {
          isGhostMode[i] = true;
        } else if (gameMode === 'all-ghosts') {
          isGhostMode[i] = true;
        }
      }
      lastGhostActivation = Date.now();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—á–∫–æ–≤
    syncScoreWithSnakeLength();
    updateScoreDisplay();
    updateModeIndicator();

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —è–±–ª–æ–∫–∞
    generateFood();

    // –¢–∞–π–º–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –µ–¥—ã
    foodTimer = setInterval(() => {
      if (gameRunning) generateFood();
    }, 4000);

    gameRunning = true;
    setupControls();

    // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–µ–ª—å–±—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      setTimeout(setupAutoShoot, 1000);
    }

    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å—é
    requestAnimationFrame(gameFrame);
  }

  // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å—é
  function gameFrame(timestamp) {
    if (!gameRunning) return;

    if (!gamePaused) {
      if (!gameSpeed.lastUpdateTime) gameSpeed.lastUpdateTime = timestamp;

      const elapsed = timestamp - gameSpeed.lastUpdateTime;

      if (elapsed >= gameSpeed.updateInterval) {
        gameLoop();
        gameSpeed.lastUpdateTime = timestamp;
      }
    } else {
      // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É
      draw();
    }

    requestAnimationFrame(gameFrame);
  }

  // –°–±—Ä–æ—Å –∏–≥—Ä—ã
  function resetGame() {
    gameRunning = false;
    gamePaused = false;

    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã
    pauseBtn.style.display = 'none';

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤
    if (foodTimer) {
      clearInterval(foodTimer);
      foodTimer = null;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter') {
      for (let i = 0; i < MAX_PLAYERS; i++) {
        if (diarrheaTimers[i]) {
          clearInterval(diarrheaTimers[i]);
          diarrheaTimers[i] = null;
        }

        if (autoShootTimers[i]) {
          clearInterval(autoShootTimers[i]);
          autoShootTimers[i] = null;
        }
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
    for (let i = 0; i < MAX_PLAYERS; i++) {
      if (ghostTimers[i]) {
        ghostTimers[i] = null;
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    document.removeEventListener('keydown', handleKeyDown);
    canvas.removeEventListener('touchstart', handleTouchStart);
    canvas.removeEventListener('touchend', handleTouchEnd);

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    const existingIndicators = document.querySelectorAll('.effect-indicator');
    existingIndicators.forEach(indicator => {
      if (indicator.parentNode) {
        indicator.parentNode.removeChild(indicator);
      }
    });

    // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    scoresDiv.innerHTML = '';
    legendDiv.innerHTML = '';
    finalScoresDiv.innerHTML = '';
    gameOverScreen.classList.remove('active');
    modeIndicator.style.display = 'none';

    setupScreen.style.display = 'flex';
    setupScreen.classList.add('active');
    controlsScreen.style.display = 'none';
    gameContainer.style.display = 'none';
  }

  // –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
  function updateSelectedModeDisplay() {
    let modeName = '–ö–ª–∞—Å—Å–∏–∫–∞';

    switch(gameMode) {
      case 'half-ghost':
        modeName = '–ü–æ–ª—É–ø—Ä–∏–∑—Ä–∞–∫';
        break;
      case 'family-ghost':
        modeName = '–°–µ–º–µ–π–∫–∞ –Ω–µ–¥–æ–ø—Ä–∏–∑—Ä–∞–∫–æ–≤';
        break;
      case 'full-ghost':
        modeName = '–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫';
        break;
      case 'all-ghosts':
        modeName = '–ö–æ–º–ø–∞—à–∫–∞ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤';
        break;
      case 'magic-shooter':
        modeName = '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä';
        break;
    }

    selectedModeDisplay.textContent = modeName;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏–≥—Ä—ã
  function validateAndStart() {
    const humans = parseInt(document.querySelector('#human-players-container .custom-select-button').dataset.value);
    const bots = parseInt(document.querySelector('#bot-count-container .custom-select-button').dataset.value);
    const total = humans + bots;

    if (humans < 1 || humans > 4) {
      errorMsg.textContent = '–ò–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 4';
      errorMsg.style.animation = 'pulseError 0.5s';
      setTimeout(() => { errorMsg.style.animation = ''; }, 500);
      return false;
    }

    if (bots < 0 || bots > 7) {
      errorMsg.textContent = '–ë–æ—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 7';
      errorMsg.style.animation = 'pulseError 0.5s';
      setTimeout(() => { errorMsg.style.animation = ''; }, 500);
      return false;
    }

    if (total > MAX_PLAYERS) {
      errorMsg.textContent = `–ú–∞–∫—Å–∏–º—É–º ${MAX_PLAYERS} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!`;
      errorMsg.style.animation = 'pulseError 0.5s';
      setTimeout(() => { errorMsg.style.animation = ''; }, 500);
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ "–ü—Ä–∏–∑—Ä–∞–∫"
    if ((gameMode === 'half-ghost' || gameMode === 'full-ghost') && humans === 0) {
      errorMsg.textContent = '–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–≥—Ä–æ–∫';
      errorMsg.style.animation = 'pulseError 0.5s';
      setTimeout(() => { errorMsg.style.animation = ''; }, 500);
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä"
    if (gameMode === 'magic-shooter' && humans === 0) {
      errorMsg.textContent = '–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–≥—Ä–æ–∫';
      errorMsg.style.animation = 'pulseError 0.5s';
      setTimeout(() => { errorMsg.style.animation = ''; }, 500);
      return false;
    }

    errorMsg.textContent = '';
    return true;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  function updatePlayerControlsVisibility() {
    const humanCount = parseInt(document.querySelector('#human-players-container .custom-select-button').dataset.value);
    const controlsList = document.getElementById('controls-list');

    if (!controlsList) return;

    for (let i = 0; i < 4; i++) {
      const row = controlsList.children[i];
      if (row) {
        row.style.display = (i < humanCount) ? 'flex' : 'none';
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
  function initCustomSelects() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    const humanPlayersContainer = document.getElementById('human-players-container');
    const humanPlayersOptions = humanPlayersContainer.querySelectorAll('.custom-select-option');

    humanPlayersOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const button = humanPlayersContainer.querySelector('.custom-select-button');
        button.textContent = option.textContent;
        button.dataset.value = option.dataset.value;
        updatePlayerControlsVisibility();
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏
      option.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          option.click();
        }
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–æ—Ç–æ–≤
    const botCountContainer = document.getElementById('bot-count-container');
    const botCountOptions = botCountContainer.querySelectorAll('.custom-select-option');

    botCountOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const button = botCountContainer.querySelector('.custom-select-button');
        button.textContent = option.textContent;
        button.dataset.value = option.dataset.value;
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏
      option.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          option.click();
        }
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
    for (let i = 0; i < 4; i++) {
      const container = document.getElementById(`control-${i}-container`);
      if (!container) continue;

      const options = container.querySelectorAll('.custom-select-option');

      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const button = container.querySelector('.custom-select-button');
          button.textContent = option.textContent;
          button.dataset.value = option.dataset.value;
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            option.click();
          }
        });
      });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Å–ø–∏—Å–∫–æ–≤
    document.addEventListener('click', (e) => {
      const isClickInside = e.target.closest('.custom-select-container');
      if (!isClickInside) {
        // –ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å, —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º :hover –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      }
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
  function initEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–æ–≤ –∏–≥—Ä—ã
    document.querySelectorAll('.mode-btn').forEach(button => {
      button.addEventListener('click', () => {
        if (button.dataset.mode === 'ghost-main') return;

        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.mode-btn, .submode-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
        button.classList.add('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        gameMode = button.dataset.mode;
        updateSelectedModeDisplay();
        updateModeIndicator();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
      button.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          button.click();
        }
      });

      // –ü–æ–∫–∞–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      button.addEventListener('mouseover', () => {
        if (button.dataset.mode !== 'ghost-main') {
          showDescription(button.dataset.mode);
        }
      });

      // –°–∫—Ä—ã—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞
      button.addEventListener('mouseout', () => {
        if (button.dataset.mode !== 'ghost-main') {
          document.querySelector('.mode-description').style.display = 'none';
        }
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ "–ü—Ä–∏–∑—Ä–∞–∫" –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–º–µ–Ω—é
    const ghostMainBtn = document.querySelector('[data-mode="ghost-main"]');
    ghostMainBtn.addEventListener('mouseover', () => {
      showDescription('ghost-main');
      document.querySelector('.mode-description').style.display = 'block';
    });

    ghostMainBtn.addEventListener('mouseout', () => {
      document.querySelector('.mode-description').style.display = 'none';
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Ä–µ–∂–∏–º–æ–≤
    document.querySelectorAll('.submode-btn').forEach(button => {
      button.addEventListener('click', () => {
        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.mode-btn, .submode-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–∫–Ω–æ–ø–∫—É
        button.classList.add('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        gameMode = button.dataset.mode;
        updateSelectedModeDisplay();
        updateModeIndicator();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ä–µ–∂–∏–º–∞
      button.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          button.click();
        }
      });

      // –ü–æ–∫–∞–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      button.addEventListener('mouseover', () => {
        showDescription(button.dataset.mode);
      });

      // –°–∫—Ä—ã—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞
      button.addEventListener('mouseout', () => {
        document.querySelector('.mode-description').style.display = 'none';
      });
    });

    // –ü–æ–∫–∞–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ
    const modeDescription = document.querySelector('.mode-description');
    modeDescription.addEventListener('mouseover', () => {
      modeDescription.style.display = 'block';
    });

    modeDescription.addEventListener('mouseout', () => {
      modeDescription.style.display = 'none';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    startControlsBtn.addEventListener('click', () => {
      if (!validateAndStart()) return;

      setupScreen.classList.remove('active');
      setTimeout(() => {
        setupScreen.style.display = 'none';
        controlsScreen.style.display = 'flex';
        controlsScreen.classList.add('active');
      }, 300);
    });

    backBtn.addEventListener('click', () => {
      controlsScreen.classList.remove('active');
      setTimeout(() => {
        controlsScreen.style.display = 'none';
        setupScreen.style.display = 'flex';
        setupScreen.classList.add('active');
      }, 300);
    });

    startBtn.addEventListener('click', () => {
      humanCount = parseInt(document.querySelector('#human-players-container .custom-select-button').dataset.value);
      const botCount = parseInt(document.querySelector('#bot-count-container .custom-select-button').dataset.value);

      if (!validateAndStart()) return;

      playerControls = [];
      for (let i = 0; i < humanCount; i++) {
        playerControls.push(document.querySelector(`#control-${i}-container .custom-select-button`).dataset.value);
      }

      if (!isMobile) {
        for (let i = 0; i < playerControls.length; i++) {
          if (playerControls[i] === 'swipe') {
            errorMsg.textContent = `–ò–≥—Ä–æ–∫ ${i + 1} –≤—ã–±—Ä–∞–ª —Å–≤–∞–π–ø—ã, –Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ —Å–µ–Ω—Å–æ—Ä–Ω–æ–µ. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.`;
            errorMsg.style.animation = 'pulseError 0.5s';
            setTimeout(() => { errorMsg.style.animation = ''; }, 500);
            return;
          }
        }
      }

      startGame(humanCount, botCount);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    const humanPlayersContainer = document.getElementById('human-players-container');
    if (humanPlayersContainer) {
      humanPlayersContainer.addEventListener('click', updatePlayerControlsVisibility);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑—ã
    pauseBtn.addEventListener('click', togglePause);
    resumeBtn.addEventListener('click', resumeGame);
    mainMenuBtn.addEventListener('click', returnToMainMenu);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
    document.addEventListener('mozfullscreenchange', updateFullscreenButton);
    document.addEventListener('MSFullscreenChange', updateFullscreenButton);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à –¥–ª—è –ø–∞—É–∑—ã –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.addEventListener('keydown', (e) => {
      // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (–∫–ª–∞–≤–∏—à–∞ C –∏–ª–∏ –°)
      if (e.key === 'c' || e.key === 'C' || e.key === '—Å' || e.key === '–°') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –≤–≤–æ–¥ –≤ –ø–æ–ª–µ (–µ—Å–ª–∏ —Ç–∞–∫–∏–µ –±—É–¥—É—Ç)
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          toggleFullscreen();
          return;
        }
      }

      // –ü–∞—É–∑–∞ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
      if (gameRunning && !gamePaused) {
        if (e.key === 'Escape' || e.key === '—ë' || e.key === '–Å' || e.key === '`' || e.key === '~') {
          e.preventDefault();
          togglePause();
          return;
        }
      }

      // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã –∏–∑ –º–µ–Ω—é –ø–∞—É–∑—ã
      if (gameRunning && gamePaused) {
        if (e.key === 'Escape' || e.key === '—ë' || e.key === '–Å' || e.key === '`' || e.key === '~') {
          e.preventDefault();
          togglePause();
          return;
        }
      }

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –º–µ–Ω—é –ø–∞—É–∑—ã —Å –ø–æ–º–æ—â—å—é Enter
      if (gamePaused && e.key === 'Enter') {
        const activeElement = document.activeElement;
        if (activeElement === resumeBtn || activeElement === mainMenuBtn) {
          e.preventDefault();
          activeElement.click();
        }
      }

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –ø–æ–º–æ—â—å—é Enter
      if (!gameRunning) {
        if (e.key === 'Enter') {
          const activeElement = document.activeElement;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–æ–π
          if (activeElement.tagName === 'BUTTON') {
            e.preventDefault();
            activeElement.click();
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ–ø—Ü–∏–µ–π –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
          if (activeElement.classList.contains('custom-select-option')) {
            e.preventDefault();
            activeElement.click();
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–æ–π —Ä–µ–∂–∏–º–∞
          if (activeElement.classList.contains('mode-btn') || activeElement.classList.contains('submode-btn')) {
            e.preventDefault();
            activeElement.click();
          }
        }
      }
    });

    // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –æ–ø—Ü–∏–∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—ã–º–∏
    document.querySelectorAll('.custom-select-option').forEach(option => {
      option.setAttribute('tabindex', '0');
    });

    document.querySelectorAll('.mode-btn, .submode-btn').forEach(btn => {
      btn.setAttribute('tabindex', '0');
    });
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞
  function showDescription(mode) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–ø–∏—Å–∞–Ω–∏—è
    document.querySelectorAll('.description-content').forEach(content => {
      content.classList.remove('active');
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    const targetDescription = document.querySelector(`.description-content[data-mode="${mode}"]`);
    if (targetDescription) {
      targetDescription.classList.add('active');
      document.querySelector('.mode-description').style.display = 'block';
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  window.addEventListener('load', () => {
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–µ–∑–¥–Ω–æ–≥–æ —Ñ–æ–Ω–∞
    createStarField();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
    resizeCanvas();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    initCustomSelects();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    initEventListeners();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    updatePlayerControlsVisibility();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    updateFullscreenButton();

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    setTimeout(() => {
      setupScreen.classList.add('active');
    }, 300);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤
    if (!ctx.roundRect) {
      ctx.roundRect = function(x, y, width, height, radius) {
        if (width < 2 * radius) radius = width / 2;
        if (height < 2 * radius) radius = height / 2;

        this.beginPath();
        this.moveTo(x + radius, y);
        this.arcTo(x + width, y, x + width, y + height, radius);
        this.arcTo(x + width, y + height, x, y + height, radius);
        this.arcTo(x, y + height, x, y, radius);
        this.arcTo(x, y, x + width, y, radius);
        this.closePath();
        return this;
      };
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', () => {
    resizeCanvas();
    createStarField();
  });

  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ —Å–≤–∞–π–ø–∞—Ö –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
  document.addEventListener('touchmove', function(e) {
    if (gameRunning && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
      e.preventDefault();
    }
  }, { passive: false });
  </script>
</body>
</html>
